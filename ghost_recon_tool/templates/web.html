{% if page != "results_fragment" %}<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ghost Recon Tool{% if page == "results" and result %} ‚Äî {{ result.domain }}{% endif %}</title>
<link rel="icon" type="image/png" href="/logo.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg-0:#04080f;--bg-1:#080d18;--bg-2:#0c1220;--bg-3:#111827;--bg-4:#1a2332;
  --border-1:#1e2d45;--border-2:#253347;
  --accent:#3b82f6;--accent-2:#06b6d4;--accent-glow:rgba(59,130,246,0.15);
  --success:#10b981;--warning:#f59e0b;--danger:#ef4444;--critical:#dc2626;
  --orange:#f97316;--purple:#8b5cf6;--pink:#ec4899;--indigo:#6366f1;
  --text-1:#f8fafc;--text-2:#94a3b8;--text-3:#475569;
  --font-mono:'JetBrains Mono','Fira Code',monospace;
  --font-sans:'Inter',system-ui,sans-serif;
  --r1:6px;--r2:10px;--r3:16px;
  --shadow:0 4px 32px rgba(0,0,0,.6);
  --glow:0 0 60px rgba(59,130,246,.08);
  --sidebar-w:240px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{min-height:100%;background:var(--bg-1);color:var(--text-1);font-family:var(--font-sans);font-size:14px;line-height:1.6}
a{color:var(--accent);text-decoration:none}a:hover{color:var(--accent-2)}
code,pre,kbd{font-family:var(--font-mono);font-size:12px}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg-0)}
::-webkit-scrollbar-thumb{background:var(--border-2);border-radius:3px}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.nav{position:sticky;top:0;z-index:700;height:54px;background:rgba(8,13,24,.95);
  backdrop-filter:blur(20px);border-bottom:1px solid var(--border-1);
  display:flex;align-items:center;padding:0 20px;gap:14px}
.nav-logo{display:flex;align-items:center;gap:10px;flex-shrink:0;cursor:pointer}
.nav-logo img{width:30px;height:30px;border-radius:8px;object-fit:contain;
  filter:drop-shadow(0 0 8px rgba(59,130,246,.4))}
.nav-brand-name{font-weight:800;font-size:13.5px;letter-spacing:.2px;color:var(--text-1)}
.nav-brand-sub{font-size:10px;color:var(--text-3);letter-spacing:.5px}
.nav-center{flex:1;display:flex;align-items:center;justify-content:center;gap:10px;font-size:12px}
.nav-links{display:flex;gap:2px;margin-left:auto}
.nav-link{padding:5px 11px;border-radius:var(--r1);color:var(--text-2);font-size:12.5px;
  font-weight:500;transition:all .15s;cursor:pointer;border:none;background:none}
.nav-link:hover{color:var(--text-1);background:rgba(255,255,255,.06)}
.nav-link.active{color:var(--accent);background:rgba(59,130,246,.12)}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border-radius:var(--r2);
  font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .15s;white-space:nowrap}
.btn-primary{background:linear-gradient(135deg,#2563eb,#0891b2);color:#fff;
  box-shadow:0 4px 16px rgba(37,99,235,.3)}
.btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px);
  box-shadow:0 6px 20px rgba(37,99,235,.4)}
.btn-primary:active{transform:translateY(0)}
.btn-ghost{background:transparent;color:var(--text-2);border:1px solid var(--border-1)}
.btn-ghost:hover{color:var(--text-1);border-color:var(--text-3);background:var(--bg-3)}
.btn-sm{padding:5px 11px;font-size:12px}
.btn-danger{background:rgba(239,68,68,.15);color:var(--danger);border:1px solid rgba(239,68,68,.3)}

/* ‚îÄ‚îÄ HOME PAGE ‚îÄ‚îÄ */
.home-bg{position:fixed;inset:0;z-index:0;overflow:hidden;pointer-events:none}
#particle-canvas{position:absolute;inset:0;width:100%;height:100%}
.home-grid{position:absolute;inset:0;
  background-image:linear-gradient(rgba(59,130,246,.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(59,130,246,.03) 1px,transparent 1px);
  background-size:50px 50px}
.home-wrap{position:relative;z-index:1;min-height:100vh;
  display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px}
.home-hero{text-align:center;margin-bottom:36px}
.home-logo{width:120px;height:120px;border-radius:24px;object-fit:contain;
  filter:drop-shadow(0 0 40px rgba(59,130,246,.4));margin-bottom:24px;
  animation:float 4s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.home-title{font-size:3.5rem;font-weight:800;letter-spacing:-1.5px;line-height:1.1;
  background:linear-gradient(135deg,#f8fafc 0%,#3b82f6 50%,#06b6d4 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:10px}
.home-subtitle{font-size:15px;color:var(--text-2);letter-spacing:.3px;margin-bottom:6px}
.home-meta{font-size:12px;color:var(--text-3);letter-spacing:.5px;margin-bottom:28px}
.home-stats{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:10px}
.stat-pill{display:inline-flex;align-items:center;gap:7px;padding:7px 14px;
  background:rgba(8,13,24,.7);border:1px solid var(--border-1);border-radius:20px;
  font-size:12px;color:var(--text-2)}
.stat-pill strong{color:var(--text-1);font-weight:700;font-family:var(--font-mono)}

/* Scan card */
.scan-card{
  background:rgba(8,13,24,.92);backdrop-filter:blur(24px);
  border:1px solid rgba(59,130,246,.18);
  box-shadow:0 0 60px rgba(59,130,246,.08),inset 0 1px 0 rgba(255,255,255,.06);
  border-radius:var(--r3);padding:28px 32px;width:100%;max-width:680px;
}
.scan-card-title{font-size:11px;font-weight:700;color:var(--text-3);
  text-transform:uppercase;letter-spacing:1.2px;margin-bottom:18px}
.input-group{position:relative;margin-bottom:16px}
.domain-input{width:100%;height:52px;background:rgba(4,8,15,.8);
  border:1.5px solid var(--border-2);border-radius:var(--r2);
  padding:0 50px 0 48px;color:var(--text-1);font-size:15px;font-family:var(--font-mono);
  outline:none;transition:all .2s}
.domain-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.2)}
.domain-input::placeholder{color:var(--text-3)}
.input-icon-left{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:16px;pointer-events:none}
.input-icon-right{position:absolute;right:14px;top:50%;transform:translateY(-50%);
  font-size:14px;pointer-events:none;transition:opacity .2s}
.mode-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:18px}
.mode-card{background:var(--bg-3);border:1.5px solid var(--border-1);border-radius:var(--r2);
  padding:12px 10px;cursor:pointer;transition:all .2s;text-align:center}
.mode-card:hover{border-color:var(--border-2);background:var(--bg-4)}
.mode-card.selected{border-color:var(--accent);background:var(--accent-glow)}
.mode-card-icon{font-size:18px;margin-bottom:4px}
.mode-card-name{font-size:12px;font-weight:700;color:var(--text-1);margin-bottom:2px}
.mode-card-time{font-size:10px;color:var(--accent);font-family:var(--font-mono)}
.mode-card-desc{font-size:10px;color:var(--text-3);margin-top:2px}
.launch-btn{width:100%;height:52px;font-size:14px;font-weight:700;
  letter-spacing:.12em;text-transform:uppercase;border-radius:var(--r2)}
.launch-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

/* Recent scans */
.recent-header{font-size:13px;font-weight:600;color:var(--text-2);
  margin:28px 0 14px;text-align:center;letter-spacing:.3px}
.recent-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;max-width:900px}
@media(max-width:700px){.recent-grid{grid-template-columns:1fr}}
.scan-hist-card{background:var(--bg-2);border:1px solid var(--border-1);border-radius:var(--r2);
  padding:14px 16px;transition:all .2s;cursor:pointer}
.scan-hist-card:hover{border-color:var(--border-2);background:var(--bg-3);transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(0,0,0,.3)}
.shc-domain{font-family:var(--font-mono);font-size:13px;font-weight:600;
  color:var(--text-1);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.shc-meta{font-size:11px;color:var(--text-3);margin-bottom:8px}
.shc-counts{display:flex;gap:6px;flex-wrap:wrap;font-size:11px}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge{display:inline-block;padding:2px 7px;border-radius:4px;
  font-size:11px;font-weight:600;font-family:var(--font-mono)}
.badge-green{background:rgba(16,185,129,.15);color:#10b981;border:1px solid rgba(16,185,129,.3)}
.badge-blue{background:rgba(59,130,246,.15);color:#3b82f6;border:1px solid rgba(59,130,246,.3)}
.badge-yellow{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3)}
.badge-orange{background:rgba(249,115,22,.15);color:#f97316;border:1px solid rgba(249,115,22,.3)}
.badge-red{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
.badge-purple{background:rgba(139,92,246,.15);color:#8b5cf6;border:1px solid rgba(139,92,246,.3)}
.badge-gray{background:rgba(148,163,184,.08);color:#94a3b8;border:1px solid rgba(148,163,184,.15)}
.badge-cyan{background:rgba(6,182,212,.15);color:#06b6d4;border:1px solid rgba(6,182,212,.3)}
.badge-indigo{background:rgba(99,102,241,.15);color:#6366f1;border:1px solid rgba(99,102,241,.3)}
.badge-pink{background:rgba(236,72,153,.15);color:#ec4899;border:1px solid rgba(236,72,153,.3)}

.risk-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;
  border-radius:20px;font-size:12px;font-weight:700;letter-spacing:.5px}
.risk-CRITICAL{background:rgba(220,38,38,.2);color:#ef4444;border:1px solid rgba(220,38,38,.4)}
.risk-HIGH{background:rgba(249,115,22,.2);color:#f97316;border:1px solid rgba(249,115,22,.4)}
.risk-MEDIUM{background:rgba(245,158,11,.2);color:#f59e0b;border:1px solid rgba(245,158,11,.4)}
.risk-LOW{background:rgba(16,185,129,.2);color:#10b981;border:1px solid rgba(16,185,129,.4)}

.sev{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:4px;
  font-size:11px;font-weight:700;letter-spacing:.4px}
.sev-CRITICAL{background:rgba(220,38,38,.2);color:#ef4444;border:1px solid rgba(220,38,38,.4)}
.sev-HIGH{background:rgba(249,115,22,.2);color:#f97316;border:1px solid rgba(249,115,22,.4)}
.sev-MEDIUM{background:rgba(245,158,11,.2);color:#f59e0b;border:1px solid rgba(245,158,11,.4)}
.sev-LOW{background:rgba(59,130,246,.15);color:#3b82f6;border:1px solid rgba(59,130,246,.3)}
.sev-INFO{background:rgba(148,163,184,.1);color:#94a3b8;border:1px solid rgba(148,163,184,.2)}

/* ‚îÄ‚îÄ SCAN OVERLAY ‚îÄ‚îÄ */
#scan-overlay{position:fixed;inset:0;z-index:1000;background:var(--bg-1);
  display:none;flex-direction:column;overflow:hidden}
#scan-overlay.visible{display:flex}
.overlay-header{padding:20px 32px;border-bottom:1px solid var(--border-1);
  display:flex;align-items:center;gap:14px;flex-shrink:0}
.overlay-logo{width:36px;height:36px;border-radius:8px;object-fit:contain;
  filter:drop-shadow(0 0 10px rgba(59,130,246,.5))}
.overlay-brand{font-weight:800;font-size:15px;color:var(--text-1)}
.overlay-brand-sub{font-size:11px;color:var(--text-3)}
.overlay-body{flex:1;display:flex;flex-direction:column;padding:24px 32px;gap:20px;overflow:hidden}
.overlay-target{text-align:center;flex-shrink:0}
.overlay-scanning{font-size:12px;color:var(--text-3);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.overlay-domain-text{font-size:1.8rem;font-weight:800;font-family:var(--font-mono);color:var(--text-1)}
.overlay-meta{display:flex;align-items:center;justify-content:center;gap:12px;
  font-size:12px;color:var(--text-2);margin-top:6px}
.overlay-progress-bar-wrap{flex-shrink:0}
.overlay-progress-label{font-size:11px;color:var(--text-3);margin-bottom:6px;
  display:flex;justify-content:space-between}
.overlay-progress-bar{height:6px;background:var(--bg-3);border-radius:3px;overflow:hidden}
.overlay-progress-fill{height:100%;width:0%;border-radius:3px;transition:width .5s ease;
  background:linear-gradient(90deg,var(--accent),var(--accent-2))}
.live-counters{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;flex-shrink:0}
.counter-card{background:var(--bg-2);border:1px solid var(--border-1);border-radius:var(--r2);
  padding:14px;text-align:center}
.counter-num{font-size:2.2rem;font-weight:800;font-family:var(--font-mono);
  color:var(--accent);line-height:1;margin-bottom:4px;transition:color .3s}
.counter-label{font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:.8px}
.modules-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;flex-shrink:0}
.module-card{background:var(--bg-2);border:1px solid var(--border-1);border-radius:var(--r2);
  padding:10px 12px;display:flex;align-items:center;gap:8px;transition:all .2s}
.module-card.running{border-color:var(--accent);background:var(--accent-glow)}
.module-card.done{border-color:rgba(16,185,129,.3);background:rgba(16,185,129,.05)}
.module-card.failed{border-color:rgba(239,68,68,.3);opacity:.6}
.module-icon{font-size:14px;flex-shrink:0}
.module-name{font-size:11px;font-weight:600;color:var(--text-2);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.module-status{font-size:11px;flex-shrink:0}
.spin{animation:spin .8s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.live-console{flex:1;background:#020408;border:1px solid var(--border-1);border-radius:var(--r2);
  overflow:hidden;display:flex;flex-direction:column;min-height:0}
.console-header{padding:8px 12px;border-bottom:1px solid var(--border-1);
  font-size:10px;color:var(--text-3);letter-spacing:1px;text-transform:uppercase;
  display:flex;align-items:center;gap:6px}
.console-dot{width:8px;height:8px;border-radius:50%;background:var(--success);
  box-shadow:0 0 6px var(--success);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.console-body{flex:1;overflow-y:auto;padding:10px 14px;font-family:var(--font-mono);
  font-size:11.5px;line-height:1.8}
.console-body::-webkit-scrollbar{width:3px}
.cl-plus{color:#10b981}.cl-minus{color:#ef4444}.cl-info{color:#3b82f6}
.cl-warn{color:#f59e0b}.cl-crit{color:#ef4444;font-weight:700}

/* ‚îÄ‚îÄ RESULTS LAYOUT ‚îÄ‚îÄ */
.results-layout{display:flex;min-height:calc(100vh - 54px)}
.sidebar{width:var(--sidebar-w);flex-shrink:0;position:sticky;top:54px;
  height:calc(100vh - 54px);overflow-y:auto;overflow-x:hidden;
  background:var(--bg-0);border-right:1px solid var(--border-1);padding:10px 6px}
.sidebar::-webkit-scrollbar{width:3px}
.sb-section{font-size:10px;text-transform:uppercase;letter-spacing:1px;
  color:var(--text-3);padding:12px 8px 5px;font-weight:700}
.sb-link{display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:var(--r1);
  color:var(--text-2);font-size:12px;font-weight:500;transition:all .15s;
  cursor:pointer;text-decoration:none;border-left:2px solid transparent}
.sb-link:hover{color:var(--text-1);background:var(--bg-2)}
.sb-link.active{color:var(--accent);background:rgba(59,130,246,.1);border-left-color:var(--accent)}
.sb-icon{font-size:13px;flex-shrink:0;width:16px;text-align:center}
.sb-label{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.sb-badge{flex-shrink:0;font-size:10px;font-weight:700;padding:1px 5px;
  border-radius:8px;background:var(--bg-3);color:var(--text-3);min-width:16px;text-align:center}
.sb-badge-red{background:rgba(239,68,68,.2);color:#ef4444}
.sb-badge-orange{background:rgba(249,115,22,.2);color:#f97316}
.sb-badge-acc{background:rgba(59,130,246,.2);color:var(--accent)}
.sb-divider{height:1px;background:var(--border-1);margin:6px 0}
.results-main{flex:1;min-width:0;padding:20px 28px 40px;overflow-x:hidden}

/* ‚îÄ‚îÄ SUMMARY BAR ‚îÄ‚îÄ */
.summary-bar{background:var(--bg-2);border:1px solid var(--border-1);
  border-radius:var(--r3);padding:20px 24px;margin-bottom:20px;
  box-shadow:var(--glow)}
.summary-top{display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-bottom:16px}
.summary-domain{font-size:22px;font-weight:800;font-family:var(--font-mono);color:var(--text-1)}
.summary-actions{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
.score-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
@media(max-width:1100px){.score-grid{grid-template-columns:repeat(3,1fr)}}
.score-card{background:var(--bg-0);border:1px solid var(--border-1);border-radius:var(--r2);
  padding:12px 14px;text-align:center}
.score-card-label{font-size:10px;color:var(--text-3);text-transform:uppercase;
  letter-spacing:.8px;margin-bottom:5px;font-weight:600}
.score-card-value{font-size:24px;font-weight:800;line-height:1;margin-bottom:5px;font-family:var(--font-mono)}
.score-bar-wrap{height:3px;background:var(--border-1);border-radius:2px;overflow:hidden}
.score-bar-fill{height:100%;border-radius:2px;transition:width 1.2s ease}
.summary-meta{display:flex;gap:14px;flex-wrap:wrap;margin-top:14px;padding-top:14px;
  border-top:1px solid var(--border-1);font-size:12px;color:var(--text-2)}
.meta-item strong{color:var(--text-1)}

/* ‚îÄ‚îÄ SECTION CARDS ‚îÄ‚îÄ */
.section-card{background:var(--bg-2);border:1px solid var(--border-1);
  border-radius:var(--r2);margin-bottom:14px;overflow:hidden}
.section-header{display:flex;align-items:center;gap:10px;padding:14px 18px;
  cursor:pointer;user-select:none;transition:background .15s;border-bottom:1px solid transparent}
.section-header:hover{background:var(--bg-3)}
.section-header.open{border-bottom-color:var(--border-1)}
.section-title{font-size:14px;font-weight:700;color:var(--text-1)}
.section-count{padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;
  background:var(--bg-3);color:var(--text-2)}
.section-count-red{background:rgba(239,68,68,.15);color:#ef4444}
.section-chevron{margin-left:auto;width:16px;height:16px;flex-shrink:0;
  transition:transform .3s ease;color:var(--text-3)}
.section-chevron.rotated{transform:rotate(-90deg)}
.section-body{overflow:hidden;transition:max-height .35s ease}
.section-inner{padding:16px 18px}

/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
.data-table{width:100%;border-collapse:collapse;font-size:12.5px}
.data-table th{text-align:left;padding:8px 12px;font-size:10.5px;text-transform:uppercase;
  letter-spacing:.7px;color:var(--text-3);border-bottom:1px solid var(--border-1);font-weight:600}
.data-table td{padding:9px 12px;border-bottom:1px solid rgba(37,51,71,.4);vertical-align:middle}
.data-table tbody tr:hover td{background:rgba(255,255,255,.02)}
.data-table .mono{font-family:var(--font-mono);font-size:12px}
.table-wrap{overflow-x:auto}

/* Port badges */
.port-b{display:inline-block;padding:2px 6px;border-radius:3px;font-size:10.5px;
  font-family:var(--font-mono);font-weight:600;margin:1px}
.port-https{background:rgba(16,185,129,.15);color:#10b981;border:1px solid rgba(16,185,129,.3)}
.port-http{background:rgba(148,163,184,.1);color:#94a3b8;border:1px solid rgba(148,163,184,.2)}
.port-ssh{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3)}
.port-danger{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
.port-other{background:rgba(59,130,246,.1);color:#3b82f6;border:1px solid rgba(59,130,246,.2)}

/* DNS type badges */
.dns-A{background:rgba(59,130,246,.15);color:#3b82f6;border:1px solid rgba(59,130,246,.3)}
.dns-AAAA{background:rgba(6,182,212,.15);color:#06b6d4;border:1px solid rgba(6,182,212,.3)}
.dns-MX{background:rgba(139,92,246,.15);color:#8b5cf6;border:1px solid rgba(139,92,246,.3)}
.dns-TXT{background:rgba(249,115,22,.15);color:#f97316;border:1px solid rgba(249,115,22,.3)}
.dns-NS{background:rgba(6,182,212,.15);color:#06b6d4;border:1px solid rgba(6,182,212,.3)}
.dns-CNAME{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3)}
.dns-SOA{background:rgba(16,185,129,.15);color:#10b981;border:1px solid rgba(16,185,129,.3)}
.dns-CAA{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
.dns-SRV{background:rgba(236,72,153,.15);color:#ec4899;border:1px solid rgba(236,72,153,.3)}
.dns-DNSKEY{background:rgba(220,38,38,.15);color:#ef4444;border:1px solid rgba(220,38,38,.3)}

/* Subdomain tag badges */
.tag-admin{background:rgba(239,68,68,.12);color:#f87171;border:1px solid rgba(239,68,68,.25);font-size:9.5px;padding:1px 5px;border-radius:3px;font-weight:700}
.tag-api{background:rgba(59,130,246,.12);color:#60a5fa;border:1px solid rgba(59,130,246,.25);font-size:9.5px;padding:1px 5px;border-radius:3px;font-weight:700}
.tag-nonprod{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.25);font-size:9.5px;padding:1px 5px;border-radius:3px;font-weight:700}
.tag-remote{background:rgba(249,115,22,.12);color:#fb923c;border:1px solid rgba(249,115,22,.25);font-size:9.5px;padding:1px 5px;border-radius:3px;font-weight:700}
.tag-email{background:rgba(139,92,246,.12);color:#a78bfa;border:1px solid rgba(139,92,246,.25);font-size:9.5px;padding:1px 5px;border-radius:3px;font-weight:700}
.tag-devops{background:rgba(99,102,241,.12);color:#818cf8;border:1px solid rgba(99,102,241,.25);font-size:9.5px;padding:1px 5px;border-radius:3px;font-weight:700}
.tag-file{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.25);font-size:9.5px;padding:1px 5px;border-radius:3px;font-weight:700}
.tag-backup{background:rgba(148,163,184,.1);color:#94a3b8;border:1px solid rgba(148,163,184,.2);font-size:9.5px;padding:1px 5px;border-radius:3px;font-weight:700}

/* Takeover */
.tak-VULNERABLE{background:rgba(239,68,68,.2);color:#ef4444;border:1px solid rgba(239,68,68,.4)}
.tak-LIKELY_VULNERABLE{background:rgba(249,115,22,.2);color:#f97316;border:1px solid rgba(249,115,22,.4)}
.tak-INVESTIGATE{background:rgba(245,158,11,.2);color:#f59e0b;border:1px solid rgba(245,158,11,.4)}

/* ‚îÄ‚îÄ VULNERABILITY CARDS ‚îÄ‚îÄ */
.vuln-filter-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
.vfilt{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;
  font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border-1);
  color:var(--text-2);background:var(--bg-3);transition:all .15s}
.vfilt:hover{border-color:var(--text-3);color:var(--text-1)}
.vfilt.active{background:rgba(59,130,246,.15);border-color:var(--accent);color:var(--accent)}
.vfilt.crit.active{background:rgba(239,68,68,.15);border-color:var(--danger);color:var(--danger)}
.vfilt.high.active{background:rgba(249,115,22,.15);border-color:var(--orange);color:var(--orange)}
.vfilt.med.active{background:rgba(245,158,11,.15);border-color:var(--warning);color:var(--warning)}
.vfilt-count{font-size:10px;font-weight:700;padding:1px 5px;border-radius:8px;background:var(--bg-1)}
.vuln-card{border:1px solid var(--border-1);border-radius:var(--r2);margin-bottom:10px;
  overflow:hidden;transition:border-color .2s}
.vuln-card:hover{border-color:var(--border-2)}
.vuln-card[data-sev="CRITICAL"]{border-left:3px solid var(--danger)}
.vuln-card[data-sev="HIGH"]{border-left:3px solid var(--orange)}
.vuln-card[data-sev="MEDIUM"]{border-left:3px solid var(--warning)}
.vuln-card[data-sev="LOW"]{border-left:3px solid var(--accent)}
.vuln-card[data-sev="INFO"]{border-left:3px solid var(--text-3)}
.vuln-header{display:flex;align-items:flex-start;gap:10px;padding:12px 14px 8px;cursor:pointer}
.vuln-title{font-size:13px;font-weight:700;flex:1;line-height:1.4;color:var(--text-1)}
.vuln-meta-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;font-size:11.5px;color:var(--text-2);padding:0 14px}
.vuln-body{padding:0 14px 14px}
.vuln-desc{font-size:12.5px;color:var(--text-2);line-height:1.6;margin-bottom:8px}
.vuln-fix{font-size:12px;color:var(--success);padding:8px 12px;
  background:rgba(16,185,129,.05);border:1px solid rgba(16,185,129,.15);
  border-radius:var(--r1);margin-bottom:6px}
.vuln-fix::before{content:"üîß Fix: "}
.nuclei-badge{background:rgba(239,68,68,.2);color:#ef4444;border:1px solid rgba(239,68,68,.4);
  font-size:10px;padding:2px 6px;border-radius:3px;font-weight:700;font-family:var(--font-mono)}
.epss-badge{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3);
  font-size:10px;padding:2px 6px;border-radius:3px;font-weight:700;font-family:var(--font-mono)}

/* ‚îÄ‚îÄ CORRELATION CARDS ‚îÄ‚îÄ */
.corr-card{border-radius:var(--r2);margin-bottom:12px;overflow:hidden;
  border:1px solid var(--border-1);transition:border-color .2s}
.corr-card:hover{border-color:var(--border-2)}
.corr-card[data-sev="CRITICAL"]{border-left:4px solid var(--danger);background:rgba(220,38,38,.03)}
.corr-card[data-sev="HIGH"]{border-left:4px solid var(--orange);background:rgba(249,115,22,.03)}
.corr-card[data-sev="MEDIUM"]{border-left:4px solid var(--warning)}
.corr-header{display:flex;align-items:center;gap:10px;padding:14px 16px}
.corr-title{font-size:13.5px;font-weight:700;flex:1;color:var(--text-1)}
.corr-body{padding:0 16px 14px}
.corr-detail{font-size:12.5px;color:var(--text-2);line-height:1.6;margin-bottom:10px}
.corr-assets{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.corr-asset{font-family:var(--font-mono);font-size:11px;padding:2px 8px;
  background:var(--bg-3);border:1px solid var(--border-1);border-radius:3px;color:var(--text-2)}
.corr-action{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.2);
  border-radius:var(--r1);padding:10px 14px;font-size:12px;color:var(--accent)}
.corr-action::before{content:"‚ö° Action: ";font-weight:700}
@keyframes critpulse{0%,100%{box-shadow:0 0 0 0 rgba(220,38,38,.3)}50%{box-shadow:0 0 0 4px rgba(220,38,38,.0)}}
.corr-card[data-sev="CRITICAL"]{animation:critpulse 2.5s ease-in-out infinite}

/* ‚îÄ‚îÄ IP CARDS ‚îÄ‚îÄ */
.ip-card{border:1px solid var(--border-1);border-radius:var(--r2);
  background:var(--bg-2);overflow:hidden;transition:border-color .2s}
.ip-card:hover{border-color:var(--border-2)}
.ip-card-threat{border-left:4px solid var(--danger);background:rgba(220,38,38,.03)}
.ip-card-vuln{border-left:4px solid var(--orange);background:rgba(249,115,22,.03)}
.ip-card-header{display:flex;align-items:center;gap:12px;padding:12px 16px;
  border-bottom:1px solid var(--border-1);flex-wrap:wrap}
.ip-addr{font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--accent);flex-shrink:0}
.ip-badges{display:flex;gap:5px;flex-wrap:wrap}
.ip-card-body{padding:12px 16px;font-size:12.5px}
.ip-meta-grid{display:flex;flex-direction:column;gap:4px;color:var(--text-2)}
.ip-ml{color:var(--text-3);font-size:11px;font-weight:600;margin-right:6px;
  text-transform:uppercase;letter-spacing:.5px}

/* ‚îÄ‚îÄ SECURITY HEADERS ‚îÄ‚îÄ */
.grade-display{display:inline-flex;align-items:center;justify-content:center;
  width:56px;height:56px;border-radius:var(--r2);font-size:26px;font-weight:900;font-family:var(--font-mono)}
.grade-A{background:rgba(16,185,129,.2);color:#10b981;border:2px solid rgba(16,185,129,.4)}
.grade-B{background:rgba(245,158,11,.2);color:#f59e0b;border:2px solid rgba(245,158,11,.4)}
.grade-C{background:rgba(249,115,22,.2);color:#f97316;border:2px solid rgba(249,115,22,.4)}
.grade-D,.grade-F{background:rgba(239,68,68,.2);color:#ef4444;border:2px solid rgba(239,68,68,.4)}
.header-row{display:flex;gap:8px;align-items:center;padding:7px 0;font-size:12.5px;
  border-bottom:1px solid var(--border-1)}
.header-row:last-child{border-bottom:none}
.hrow-name{flex:1;font-weight:600}
.hrow-val{font-family:var(--font-mono);font-size:11px;color:var(--text-2);
  max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.check-ok{color:var(--success)}.check-miss{color:var(--danger)}

/* ‚îÄ‚îÄ WHOIS ‚îÄ‚îÄ */
.kv-grid{display:grid;grid-template-columns:160px 1fr;gap:0}
.kv-key{padding:7px 12px 7px 0;font-size:12px;color:var(--text-3);font-weight:600;
  border-bottom:1px solid var(--border-1)}
.kv-val{padding:7px 0;font-size:12.5px;color:var(--text-1);border-bottom:1px solid var(--border-1);
  font-family:var(--font-mono);word-break:break-all}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.empty-state{text-align:center;padding:36px 20px;color:var(--text-3)}
.ei{font-size:36px;margin-bottom:10px;opacity:.4}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
.filter-input{background:var(--bg-0);border:1px solid var(--border-1);border-radius:var(--r1);
  padding:5px 10px;color:var(--text-1);font-size:12px;font-family:var(--font-mono);
  outline:none;transition:border-color .2s;max-width:220px}
.filter-input:focus{border-color:var(--accent)}
.hidden{display:none!important}
.section-alert{padding:12px 16px;border-radius:var(--r1);font-size:13px;font-weight:600;
  margin-bottom:14px;display:flex;align-items:center;gap:8px}
.alert-red{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#f87171}
.alert-yellow{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:#fbbf24}
.alert-blue{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:#60a5fa}
.dropdown{position:relative;display:inline-block}
.dropdown-menu{position:absolute;top:calc(100% + 4px);right:0;z-index:400;
  background:var(--bg-3);border:1px solid var(--border-1);border-radius:var(--r2);
  min-width:160px;box-shadow:var(--shadow);display:none;overflow:hidden}
.dropdown-menu.open{display:block}
.dropdown-item{display:block;padding:9px 14px;font-size:13px;color:var(--text-2);
  cursor:pointer;transition:all .1s;text-decoration:none}
.dropdown-item:hover{background:var(--bg-2);color:var(--text-1)}
.dropdown-divider{height:1px;background:var(--border-1);margin:4px 0}
.footer{text-align:center;padding:20px;font-size:11px;color:var(--text-3);
  border-top:1px solid var(--border-1);margin-top:40px}

/* Sub row highlighting */
.sub-vuln td:first-child{border-left:3px solid var(--danger)}
.sub-nonprod td:first-child{border-left:3px solid var(--warning)}
.sub-admin td:first-child{border-left:3px solid var(--accent)}
.sub-remote td:first-child{border-left:3px solid var(--orange)}
</style>
</head>
<body>
{% endif %}{# end results_fragment check #}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if page != "results_fragment" %}
<nav class="nav">
  <div class="nav-logo" onclick="location.href='/'">
    <img src="/logo.png" alt="Ghost Recon Tool">
    <div><div class="nav-brand-name">Ghost Recon Tool</div>
    <div class="nav-brand-sub">by mnt0x ¬∑ v2.0</div></div>
  </div>
  {% if page in ("results","results_fragment") and result %}
  <div class="nav-center">
    <span style="font-family:var(--font-mono);font-size:13px;color:var(--text-1);font-weight:700">{{ result.domain }}</span>
    <span class="badge badge-blue">{{ result.mode }}</span>
    {% set scores = result.scores if result.scores else {} %}
    <span class="risk-badge risk-{{ scores.get('risk_level','LOW') }}">{{ scores.get('risk_level','?') }}</span>
  </div>
  {% endif %}
  <div class="nav-links">
    <button class="nav-link {% if page=='home' %}active{% endif %}" onclick="location.href='/'">üè† Home</button>
    <button class="nav-link {% if page=='history' %}active{% endif %}" onclick="location.href='/history'">üìã History</button>
    <button class="nav-link {% if page=='settings' %}active{% endif %}" onclick="location.href='/settings'">‚öôÔ∏è Settings</button>
  </div>
</nav>
{% endif %}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCAN OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if page == "home" %}
<div id="scan-overlay">
  <div class="overlay-header">
    <img src="/logo.png" alt="" class="overlay-logo">
    <div><div class="overlay-brand">Ghost Recon Tool</div>
    <div class="overlay-brand-sub">by mnt0x ¬∑ v2.0 ¬∑ Passive Intelligence Platform</div></div>
    <div style="margin-left:auto;font-family:var(--font-mono);font-size:13px;color:var(--text-2)" id="overlay-timer">00:00</div>
  </div>
  <div class="overlay-body">
    <div class="overlay-target">
      <div class="overlay-scanning">Scanning</div>
      <div class="overlay-domain-text" id="overlay-domain">‚Äî</div>
      <div class="overlay-meta">
        <span id="overlay-mode-badge" class="badge badge-blue">balanced</span>
        <span id="overlay-status" style="color:var(--text-3)">Initializing...</span>
      </div>
    </div>
    <div class="overlay-progress-bar-wrap">
      <div class="overlay-progress-label">
        <span>Progress</span><span id="overlay-pct">0%</span>
      </div>
      <div class="overlay-progress-bar">
        <div class="overlay-progress-fill" id="overlay-bar"></div>
      </div>
    </div>
    <div class="live-counters">
      <div class="counter-card"><div class="counter-num" id="cnt-subs">0</div><div class="counter-label">Subdomains</div></div>
      <div class="counter-card"><div class="counter-num" id="cnt-emails">0</div><div class="counter-label">Emails</div></div>
      <div class="counter-card"><div class="counter-num" id="cnt-ips">0</div><div class="counter-label">IPs</div></div>
      <div class="counter-card"><div class="counter-num" id="cnt-vulns">0</div><div class="counter-label">Vulns</div></div>
    </div>
    <div class="modules-grid" id="modules-grid">
      {% set mods = [("üîç","DNS","dns"),("üåê","Subdomains","subdomains"),("üìß","Emails","emails"),("‚öôÔ∏è","Technologies","tech"),("üìã","WHOIS","whois"),("üñ•Ô∏è","IP Intel","ip"),("üîí","SSL/TLS","ssl"),("üì¶","Web Archive","archive"),("üö®","Breaches","breach"),("üè∑Ô∏è","Reputation","rep"),("‚òÅÔ∏è","Cloud","cloud"),("üé≠","Takeover","takeover"),("üí£","Vulns","vulns"),("üìä","Scoring","score"),("üîó","Correlations","corr"),("üõ°Ô∏è","Sec Headers","headers")] %}
      {% for icon,name,key in mods %}
      <div class="module-card" id="mod-{{ key }}">
        <span class="module-icon">{{ icon }}</span>
        <span class="module-name">{{ name }}</span>
        <span class="module-status" id="mods-{{ key }}">‚è≥</span>
      </div>
      {% endfor %}
    </div>
    <div class="live-console">
      <div class="console-header"><div class="console-dot"></div>Live Feed</div>
      <div class="console-body" id="console-log"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="home-page">
  <div class="home-bg">
    <div class="home-grid"></div>
    <canvas id="particle-canvas"></canvas>
  </div>
  <div class="home-wrap">
    <div class="home-hero">
      <img src="/logo.png" alt="Ghost Recon Tool" class="home-logo">
      <div class="home-title">Ghost Recon Tool</div>
      <div class="home-subtitle">Passive Domain Intelligence Platform</div>
      <div class="home-meta">by mnt0x ¬∑ v3.0 ¬∑ 16 modules ¬∑ 50+ sources ¬∑ 60+ DKIM selectors ¬∑ Zero target contact</div>
      <div class="home-stats">
        {% set total_subs = history|sum(attribute='subdomains') if history else 0 %}
        {% set total_scans = history|length if history else 0 %}
        <div class="stat-pill">üéØ Scans: <strong>{{ total_scans }}</strong></div>
        <div class="stat-pill">üåê Subdomains Found: <strong>{{ total_subs }}</strong></div>
        <div class="stat-pill">üîì Zero Config Required</div>
      </div>
    </div>
    <div class="scan-card">
      <div class="scan-card-title">Launch Reconnaissance</div>
      <div class="input-group">
        <span class="input-icon-left">üîç</span>
        <input id="domain-input" type="text" class="domain-input" placeholder="target.com"
               oninput="validateDomain(this)" autocomplete="off" autocapitalize="off">
        <span class="input-icon-right" id="domain-valid-icon"></span>
      </div>
      <div class="scan-card-title" style="margin-bottom:10px">Scan Mode</div>
      <div class="mode-grid">
        <div class="mode-card" data-mode="fast" onclick="selectMode('fast')">
          <div class="mode-card-icon">‚ö°</div>
          <div class="mode-card-name">FAST</div>
          <div class="mode-card-time">15-30s</div>
          <div class="mode-card-desc">Core sources only</div>
        </div>
        <div class="mode-card selected" data-mode="balanced" onclick="selectMode('balanced')">
          <div class="mode-card-icon">üéØ</div>
          <div class="mode-card-name">BALANCED</div>
          <div class="mode-card-time">1-2 min</div>
          <div class="mode-card-desc">Recommended</div>
        </div>
        <div class="mode-card" data-mode="deep" onclick="selectMode('deep')">
          <div class="mode-card-icon">üî¨</div>
          <div class="mode-card-name">DEEP</div>
          <div class="mode-card-time">3-8 min</div>
          <div class="mode-card-desc">Max coverage</div>
        </div>
        <div class="mode-card" data-mode="turbo" onclick="selectMode('turbo')">
          <div class="mode-card-icon">üíÄ</div>
          <div class="mode-card-name">TURBO</div>
          <div class="mode-card-time">No limits</div>
          <div class="mode-card-desc">Lab use only</div>
        </div>
      </div>
      <button id="launch-btn" class="btn btn-primary launch-btn" onclick="launchScan()" disabled>
        LAUNCH RECONNAISSANCE
      </button>
    </div>
    {% if history %}
    <div class="recent-header">Recent Scans</div>
    <div class="recent-grid">
      {% for h in history[:6] %}
      <div class="scan-hist-card" onclick="location.href='/results/{{ h.scan_id }}'">
        <div class="shc-domain">{{ h.domain }}</div>
        <div class="shc-meta">{{ h.scan_date[:10] if h.scan_date else '?' }} ¬∑ {{ h.mode }}</div>
        <div class="shc-counts">
          <span class="risk-badge risk-{{ h.risk_level }}">{{ h.risk_level }}</span>
          <span class="badge badge-gray">{{ h.subdomains }} subs</span>
          <span class="badge badge-gray">{{ h.emails }} emails</span>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  <div class="footer">Ghost Recon Tool ¬∑ Passive OSINT Platform ¬∑ created by mnt0x</div>
</div>
{% endif %}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if page == "history" %}
<div style="max-width:1100px;margin:0 auto;padding:28px 20px">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
    <div>
      <div style="font-size:22px;font-weight:800;color:var(--text-1)">üìã Scan History</div>
      <div style="font-size:13px;color:var(--text-3);margin-top:2px">{{ history|length }} scan{% if history|length != 1 %}s{% endif %} stored</div>
    </div>
    <a href="/" class="btn btn-primary btn-sm">+ New Scan</a>
  </div>
  {% if history %}
  <div style="display:flex;flex-direction:column;gap:10px">
  {% for h in history %}
  <div style="background:var(--bg-2);border:1px solid var(--border-1);border-radius:var(--r2);padding:0;overflow:hidden;
              transition:border-color .2s;display:flex;align-items:stretch"
       onmouseover="this.style.borderColor='var(--border-2)'" onmouseout="this.style.borderColor='var(--border-1)'">
    <!-- Risk band -->
    <div style="width:5px;flex-shrink:0;background:{% if h.risk_level=='CRITICAL' %}var(--danger){% elif h.risk_level=='HIGH' %}var(--orange){% elif h.risk_level=='MEDIUM' %}var(--warning){% else %}var(--success){% endif %}"></div>
    <div style="flex:1;padding:14px 18px;display:flex;align-items:center;gap:20px;flex-wrap:wrap">
      <!-- Domain / date -->
      <div style="flex:0 0 auto;min-width:200px">
        <div style="font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--accent)">{{ h.domain }}</div>
        <div style="font-size:11px;color:var(--text-3);margin-top:2px">{{ h.scan_date[:19] if h.scan_date else '‚Äî' }}</div>
      </div>
      <!-- Mode / risk -->
      <div style="display:flex;gap:6px;align-items:center">
        <span class="badge badge-blue">{{ h.mode }}</span>
        <span class="risk-badge risk-{{ h.risk_level }}">{{ h.risk_level }}</span>
        <span style="font-family:var(--font-mono);font-size:13px;font-weight:700;color:var(--text-2)">{{ h.overall_score }}/100</span>
      </div>
      <!-- Stats -->
      <div style="display:flex;gap:16px;font-size:12px;color:var(--text-2)">
        <span>üåê <strong style="color:var(--text-1)">{{ h.subdomains }}</strong> subs</span>
        <span>üìß <strong style="color:var(--text-1)">{{ h.emails }}</strong> emails</span>
        <span>üí£ <strong style="color:{% if h.vulns > 0 %}var(--danger){% else %}var(--text-1){% endif %}">{{ h.vulns }}</strong> vulns</span>
        <span>‚è± <strong style="color:var(--text-3)">{{ h.duration }}s</strong></span>
      </div>
      <!-- Actions -->
      <div style="margin-left:auto;display:flex;gap:6px">
        <a href="/results/{{ h.scan_id }}" class="btn btn-ghost btn-sm">View</a>
        <a href="/api/download/{{ h.scan_id }}/json" class="btn btn-ghost btn-sm">‚¨á</a>
      </div>
    </div>
  </div>
  {% endfor %}
  </div>
  {% else %}
  <div class="empty-state"><div class="ei">üìã</div>No scans yet. <a href="/">Go scan something!</a></div>
  {% endif %}
</div>
<div class="footer">Ghost Recon Tool ¬∑ Passive OSINT Platform ¬∑ created by mnt0x</div>
{% endif %}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if page == "settings" %}
<div style="max-width:800px;margin:0 auto;padding:32px 20px">
  {% if saved %}
  <div style="background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.3);color:#10b981;border-radius:var(--r2);padding:12px 18px;margin-bottom:20px;font-weight:600">
    ‚úÖ API keys saved successfully! Server reloaded new keys.
  </div>
  {% endif %}
  <div style="font-size:22px;font-weight:800;margin-bottom:6px">‚öôÔ∏è API Key Settings</div>
  <div style="color:var(--text-3);margin-bottom:24px;font-size:13px">
    Keys are stored in <code>.env</code> in the tool directory. Leave a field blank to keep the existing value. All data stays local.
  </div>
  <form method="POST" action="/api/settings">
    <div style="background:var(--bg-2);border:1px solid var(--border-1);border-radius:var(--r3);padding:0;overflow:hidden">
      {% for item in api_key_list %}
      <div style="display:flex;align-items:center;gap:16px;padding:14px 20px;border-bottom:1px solid var(--border-1);{% if loop.last %}border-bottom:none{% endif %}">
        <div style="flex:0 0 200px">
          <div style="font-weight:600;font-size:13px;color:var(--text-1)">{{ item.key.replace('_',' ').title() }}</div>
          <div style="font-size:11px;color:var(--text-3);font-family:var(--font-mono)">{{ item.env_var }}</div>
        </div>
        <div style="flex:1">
          <input
            type="password"
            name="{{ item.key }}"
            placeholder="{% if item.set %}{{ item.masked }} (set ‚Äî enter new value to change){% else %}Not configured{% endif %}"
            autocomplete="new-password"
            style="width:100%;background:var(--bg-3);border:1px solid var(--border-1);border-radius:var(--r1);
                   color:var(--text-1);padding:7px 12px;font-family:var(--font-mono);font-size:12px;outline:none;
                   transition:border .15s"
            onfocus="this.style.borderColor='var(--accent)'"
            onblur="this.style.borderColor='var(--border-1)'"
          >
        </div>
        <div style="flex:0 0 80px;text-align:right">
          {% if item.set %}
          <span style="font-size:11px;color:var(--success);font-weight:700">‚óè SET</span>
          {% else %}
          <span style="font-size:11px;color:var(--text-3)">‚óã empty</span>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    <div style="margin-top:20px;display:flex;gap:12px;align-items:center">
      <button type="submit" style="padding:10px 28px;background:var(--accent);color:#fff;border:none;border-radius:var(--r2);
               font-weight:700;font-size:13px;cursor:pointer;transition:opacity .15s"
              onmouseover="this.style.opacity='.85'" onmouseout="this.style.opacity='1'">
        Save API Keys
      </button>
      <a href="/" style="padding:10px 20px;background:var(--bg-3);color:var(--text-2);border:1px solid var(--border-1);
               border-radius:var(--r2);font-weight:600;font-size:13px">
        Cancel
      </a>
      <span style="margin-left:auto;font-size:12px;color:var(--text-3)">
        üîí Keys stored locally in <code style="color:var(--accent-2)">.env</code> ‚Äî never sent anywhere
      </span>
    </div>
  </form>

  <div style="margin-top:36px;background:var(--bg-2);border:1px solid var(--border-1);border-radius:var(--r2);padding:20px">
    <div style="font-weight:700;margin-bottom:12px;color:var(--text-2)">üìö Where to get API keys</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;color:var(--text-3)">
      <div>üîç <strong style="color:var(--text-2)">VirusTotal</strong> ‚Äî <a href="https://www.virustotal.com/gui/user/apikey" target="_blank">virustotal.com</a> (free tier: 500 req/day)</div>
      <div>üîç <strong style="color:var(--text-2)">SecurityTrails</strong> ‚Äî <a href="https://securitytrails.com/app/account" target="_blank">securitytrails.com</a> (50 req/month free)</div>
      <div>üìß <strong style="color:var(--text-2)">Hunter.io</strong> ‚Äî <a href="https://hunter.io/api-keys" target="_blank">hunter.io</a> (25 req/month free)</div>
      <div>üåê <strong style="color:var(--text-2)">URLScan</strong> ‚Äî <a href="https://urlscan.io/user/profile" target="_blank">urlscan.io</a> (free)</div>
      <div>üêô <strong style="color:var(--text-2)">GitHub Token</strong> ‚Äî <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a></div>
      <div>üî≠ <strong style="color:var(--text-2)">Shodan</strong> ‚Äî <a href="https://account.shodan.io/" target="_blank">shodan.io</a> (membership required)</div>
      <div>üëæ <strong style="color:var(--text-2)">AlienVault OTX</strong> ‚Äî <a href="https://otx.alienvault.com/settings" target="_blank">otx.alienvault.com</a> (free)</div>
      <div>üîì <strong style="color:var(--text-2)">HIBP</strong> ‚Äî <a href="https://haveibeenpwned.com/API/Key" target="_blank">haveibeenpwned.com/API/Key</a> (paid)</div>
      <div>üåÄ <strong style="color:var(--text-2)">Chaos (PDC)</strong> ‚Äî <a href="https://chaos.projectdiscovery.io/" target="_blank">chaos.projectdiscovery.io</a> (invite)</div>
      <div>üêæ <strong style="color:var(--text-2)">FullHunt</strong> ‚Äî <a href="https://fullhunt.io/user/apikey" target="_blank">fullhunt.io</a> (free tier)</div>
      <div>üìä <strong style="color:var(--text-2)">AbuseIPDB</strong> ‚Äî <a href="https://www.abuseipdb.com/account/api" target="_blank">abuseipdb.com</a> (free tier)</div>
      <div>üîë <strong style="color:var(--text-2)">IntelX</strong> ‚Äî <a href="https://intelx.io/account?tab=developer" target="_blank">intelx.io</a> (free trial)</div>
    </div>
  </div>
</div>
<div class="footer">Ghost Recon Tool ¬∑ Passive OSINT Platform ¬∑ created by mnt0x</div>
{% endif %}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if page in ("results","results_fragment") and result %}
{% set r = result %}
{% set scores = r.scores if r.scores else {} %}
{% set vulns = r.vulnerabilities if r.vulnerabilities else [] %}
{% set correlations = r.correlations if r.correlations else [] %}
{% set subdomains = r.subdomains if r.subdomains else [] %}
{% set emails = r.emails if r.emails else [] %}
{% set dns_records = r.dns_records if r.dns_records else [] %}
{% set ip_records = r.ip_records if r.ip_records else [] %}
{% set takeover_records = r.takeover_records if r.takeover_records else [] %}
{% set technologies = r.technologies if r.technologies else [] %}
{% set breach_records = r.breach_records if r.breach_records else [] %}
{% set cloud_assets = r.cloud_assets if r.cloud_assets else [] %}
{% set ssl_info = r.ssl_info if r.ssl_info else [] %}
{% set typosquats = r.typosquats if r.typosquats else [] %}
{% set social = r.social_footprint if r.social_footprint else {} %}
{% set asn_data = r.asn_intelligence if r.asn_intelligence else {} %}
{% set security_headers = r.security_headers if r.security_headers else {} %}
{% set whois_data = r.whois_data if r.whois_data else {} %}
{% set reputation_data = r.reputation_data if r.reputation_data else {} %}
{% set wayback = r.wayback_urls if r.wayback_urls else {} %}
{% set email_pattern = r.email_pattern if r.email_pattern else {} %}
{% set scan_id = r.scan_id %}

{% set crit_vulns = [] %}{% for _v in (vulns or []) %}{% set _vs = (_v.get('severity','') if _v is mapping else _v.severity|default(''))|string %}{% if _vs == 'CRITICAL' %}{% set _ = crit_vulns.append(_v) %}{% endif %}{% endfor %}
{% set high_vulns = [] %}{% for _v in (vulns or []) %}{% set _vs = (_v.get('severity','') if _v is mapping else _v.severity|default(''))|string %}{% if _vs == 'HIGH' %}{% set _ = high_vulns.append(_v) %}{% endif %}{% endfor %}
{% set med_vulns = [] %}{% for _v in (vulns or []) %}{% set _vs = (_v.get('severity','') if _v is mapping else _v.severity|default(''))|string %}{% if _vs == 'MEDIUM' %}{% set _ = med_vulns.append(_v) %}{% endif %}{% endfor %}
{% set low_vulns = [] %}{% for _v in (vulns or []) %}{% set _vs = (_v.get('severity','') if _v is mapping else _v.severity|default(''))|string %}{% if _vs == 'LOW' %}{% set _ = low_vulns.append(_v) %}{% endif %}{% endfor %}
{% set crit_corr = [] %}{% for _c in (correlations or []) %}{% set _cs = (_c.get('severity','') if _c is mapping else _c.severity|default(''))|string %}{% if _cs == 'CRITICAL' %}{% set _ = crit_corr.append(_c) %}{% endif %}{% endfor %}
{% set vuln_takeovers = [] %}{% for _t in (takeover_records or []) %}{% set _ts = (_t.get('status','') if _t is mapping else _t.status|default(''))|string %}{% if _ts == 'VULNERABLE' %}{% set _ = vuln_takeovers.append(_t) %}{% endif %}{% endfor %}

<div class="results-layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div style="padding:10px 8px 6px">
      <div style="font-family:var(--font-mono);font-size:13px;font-weight:700;color:var(--text-1);margin-bottom:2px">{{ r.domain }}</div>
      <span class="risk-badge risk-{{ scores.get('risk_level','LOW') }}" style="font-size:11px;padding:3px 10px">
        {{ scores.get('risk_level','?') }} ¬∑ {{ scores.get('overall',0) }}/100
      </span>
    </div>
    <div class="sb-divider"></div>
    <a class="sb-link" href="#sec-overview" onclick="scrollTo('sec-overview')"><span class="sb-icon">üéØ</span><span class="sb-label">Overview</span></a>
    {% if correlations %}
    <a class="sb-link" href="#sec-correlations" onclick="scrollTo('sec-correlations')">
      <span class="sb-icon">üîó</span><span class="sb-label">Correlations</span>
      <span class="sb-badge {% if crit_corr %}sb-badge-red{% else %}sb-badge-orange{% endif %}">{{ correlations|length }}</span>
    </a>
    {% endif %}
    <a class="sb-link" href="#sec-vulns" onclick="scrollTo('sec-vulns')">
      <span class="sb-icon">üí£</span><span class="sb-label">Vulnerabilities</span>
      <span class="sb-badge {% if crit_vulns %}sb-badge-red{% elif high_vulns %}sb-badge-orange{% else %}sb-badge-acc{% endif %}">{{ vulns|length }}</span>
    </a>
    <div class="sb-divider"></div>
    {% for icon,label,anchor,count in [("üåê","Subdomains","sec-subdomains",subdomains|length),("üìß","Emails","sec-emails",emails|length),("‚öôÔ∏è","Technologies","sec-tech",technologies|length),("üîç","DNS","sec-dns",dns_records|length),("üìã","WHOIS","sec-whois",1),("üñ•Ô∏è","IP / ASN","sec-ip",ip_records|length),("üîí","SSL / TLS","sec-ssl",ssl_info|length),("üì¶","Web Archive","sec-archive",1),("üö®","Breaches","sec-breach",breach_records|length),("‚òÅÔ∏è","Cloud","sec-cloud",cloud_assets|length),("üé≠","Takeover","sec-takeover",takeover_records|length),("üè∑Ô∏è","Reputation","sec-rep",1),("üë•","Social","sec-social",1),("üîê","Sec Headers","sec-headers",1),("üî§","Typosquatting","sec-typo",typosquats|length)] %}
    <a class="sb-link" href="#{{ anchor }}" onclick="scrollTo('{{ anchor }}')">
      <span class="sb-icon">{{ icon }}</span><span class="sb-label">{{ label }}</span>
      <span class="sb-badge">{{ count }}</span>
    </a>
    {% endfor %}
  </aside>

  <!-- MAIN -->
  <main class="results-main">
    <!-- SUMMARY BAR -->
    <div class="summary-bar" id="sec-overview">
      <div class="summary-top">
        <div class="summary-domain">{{ r.domain }}</div>
        <span class="risk-badge risk-{{ scores.get('risk_level','LOW') }}">{{ scores.get('risk_level','?') }}</span>
        <div class="summary-actions">
          <div class="dropdown">
            <button class="btn btn-ghost btn-sm" onclick="toggleDropdown('dl-dd')">‚¨á Download ‚ñæ</button>
            <div class="dropdown-menu" id="dl-dd">
              <a class="dropdown-item" href="/api/download/{{ scan_id }}/json">üìÑ JSON (Full)</a>
              <a class="dropdown-item" href="/api/download/{{ scan_id }}/txt">üìù TXT Report</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="/api/download/{{ scan_id }}/csv_subdomains">üìä CSV ‚Äî Subdomains</a>
              <a class="dropdown-item" href="/api/download/{{ scan_id }}/csv_emails">üìä CSV ‚Äî Emails</a>
              <a class="dropdown-item" href="/api/download/{{ scan_id }}/csv_vulns">üìä CSV ‚Äî Vulnerabilities</a>
            </div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="location.href='/'">+ New Scan</button>
        </div>
      </div>
      <div class="score-grid">
        {% for label, key, color in [("Overall","overall","#3b82f6"),("Subdomain","subdomain","#06b6d4"),("Email","email","#8b5cf6"),("Vuln","vuln","#ef4444"),("Config","config","#f59e0b"),("Exposure","exposure","#f97316")] %}
        {% set v = scores.get(key, scores.get('overall',0)) %}
        <div class="score-card">
          <div class="score-card-label">{{ label }}</div>
          <div class="score-card-value" style="color:{{ color }}">{{ v }}</div>
          <div class="score-bar-wrap"><div class="score-bar-fill" style="width:{{ v }}%;background:{{ color }}"></div></div>
        </div>
        {% endfor %}
      </div>
      <div class="summary-meta">
        <span class="meta-item">üìÖ <strong>{{ r.scan_date[:19] if r.scan_date else '?' }}</strong></span>
        <span class="meta-item">‚öôÔ∏è <strong>{{ r.mode }}</strong></span>
        <span class="meta-item">‚è±Ô∏è <strong>{{ r.duration_seconds }}s</strong></span>
        <span class="meta-item">üåê <strong>{{ subdomains|length }}</strong> subdomains</span>
        <span class="meta-item">üìß <strong>{{ emails|length }}</strong> emails</span>
        <span class="meta-item">üõ°Ô∏è <strong>{{ vulns|length }}</strong> vulns</span>
        {% if correlations %}<span class="meta-item">üîó <strong>{{ correlations|length }}</strong> correlations</span>{% endif %}
      </div>
    </div>

    <!-- CORRELATIONS -->
    {% if correlations %}
    <div class="section-card" id="sec-correlations">
      <div class="section-header open" onclick="toggleSection('corr')">
        <span class="section-title">üîó Intelligence Correlations</span>
        <span class="section-count section-count-red">{{ correlations|length }}</span>
        <svg class="section-chevron" id="chev-corr" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-corr" data-default="open">
        <div class="section-inner">
          {% if crit_corr %}
          <div class="section-alert alert-red">üö® {{ crit_corr|length }} CRITICAL findings require immediate action</div>
          {% endif %}
          {% for c in correlations %}
          <div class="corr-card" data-sev="{{ c.severity }}">
            <div class="corr-header">
              <span class="sev sev-{{ c.severity }}">{{ c.severity }}</span>
              <span class="corr-title">{{ c.title }}</span>
            </div>
            <div class="corr-body">
              <div class="corr-detail">{{ c.detail }}</div>
              {% if c.assets %}
              <div class="corr-assets">
                {% for a in c.assets %}<span class="corr-asset">{{ a }}</span>{% endfor %}
              </div>
              {% endif %}
              <div class="corr-action">{{ c.action }}</div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- VULNERABILITIES -->
    <div class="section-card" id="sec-vulns">
      <div class="section-header open" onclick="toggleSection('vulns')">
        <span class="section-title">üí£ Vulnerabilities</span>
        <span class="section-count {% if crit_vulns %}section-count-red{% endif %}">
          CRITICAL: {{ crit_vulns|length }} ¬∑ HIGH: {{ high_vulns|length }} ¬∑ Total: {{ vulns|length }}
        </span>
        <svg class="section-chevron" id="chev-vulns" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-vulns" data-default="open">
        <div class="section-inner">
          {% if vulns %}
          <div class="vuln-filter-bar">
            <button class="vfilt active" onclick="filterVulns('ALL',this)">ALL <span class="vfilt-count">{{ vulns|length }}</span></button>
            <button class="vfilt crit" onclick="filterVulns('CRITICAL',this)">CRITICAL <span class="vfilt-count">{{ crit_vulns|length }}</span></button>
            <button class="vfilt high" onclick="filterVulns('HIGH',this)">HIGH <span class="vfilt-count">{{ high_vulns|length }}</span></button>
            <button class="vfilt med" onclick="filterVulns('MEDIUM',this)">MEDIUM <span class="vfilt-count">{{ med_vulns|length }}</span></button>
            <button class="vfilt low" onclick="filterVulns('LOW',this)">LOW <span class="vfilt-count">{{ low_vulns|length }}</span></button>
          </div>
          {% for v in vulns %}
          {% set sev = v.severity|default('INFO') %}
          <div class="vuln-card" data-sev="{{ sev }}" id="vc-{{ loop.index }}">
            <div class="vuln-header" onclick="toggleVuln('vb-{{ loop.index }}')">
              <span class="sev sev-{{ sev }}">{{ sev }}</span>
              <span class="vuln-title">
                {% if v.cve_id and v.cve_id.startswith('CVE-') %}
                <a href="https://nvd.nist.gov/vuln/detail/{{ v.cve_id }}" target="_blank" style="color:var(--accent)" onclick="event.stopPropagation()">{{ v.cve_id }}</a> ‚Äî
                {% endif %}
                {{ v.title|default('')|replace(v.cve_id|default('###NOKEY###') + ' ‚Äî ', '') }}
              </span>
              {% if v.get('has_nuclei_template') %}<span class="nuclei-badge">Has PoC</span>{% endif %}
              {% if v.get('epss_score') %}<span class="epss-badge">EPSS {{ "%.0f"|format(v.epss_score * 100) }}%</span>{% endif %}
              {% if v.cvss_score %}<span class="badge badge-{% if v.cvss_score|float >= 9 %}red{% elif v.cvss_score|float >= 7 %}orange{% elif v.cvss_score|float >= 4 %}yellow{% else %}green{% endif %}">CVSS {{ v.cvss_score }}</span>{% endif %}
              {% if v.source == 'tech_cve_mapping' %}<span style="background:rgba(139,92,246,.15);color:#a78bfa;border:1px solid rgba(139,92,246,.3);font-size:9.5px;padding:1px 6px;border-radius:3px;font-weight:700">Tech CVE</span>{% endif %}
            </div>
            <div class="vuln-meta-row">
              <span>üìç {{ v.affected_asset|default('') }}</span>
              <span>üè∑Ô∏è {{ v.source|default('') }}</span>
            </div>
            <div id="vb-{{ loop.index }}" class="hidden">
              <div class="vuln-body">
                {% if v.description %}<div class="vuln-desc">{{ v.description }}</div>{% endif %}
                {% if v.remediation %}<div class="vuln-fix">{{ v.remediation }}</div>{% endif %}
                {% if v.references %}<div style="font-size:11px;color:var(--text-3);margin-top:6px">
                  {% for ref in v.references %}<a href="{{ ref }}" target="_blank" style="color:var(--accent);font-family:var(--font-mono);font-size:11px;margin-right:8px">{{ ref[:60] }}{% if ref|length > 60 %}‚Ä¶{% endif %}</a>{% endfor %}
                </div>{% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div class="empty-state"><div class="ei">‚úÖ</div>No vulnerabilities detected.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- SUBDOMAINS -->
    <div class="section-card" id="sec-subdomains">
      <div class="section-header open" onclick="toggleSection('subdomains')">
        <span class="section-title">üåê Subdomains</span>
        <span class="section-count">{{ subdomains|length }}</span>
        <svg class="section-chevron" id="chev-subdomains" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-subdomains" data-default="open">
        <div class="section-inner">
          {% if subdomains %}
          {% set sub_nonprod = [] %}{% set sub_admin = [] %}{% set sub_takeover = [] %}{% set with_ips_count = namespace(v=0) %}
          {% for s in subdomains %}
            {% set _tags = (s.get('tags') or []) if s is mapping else (s.tags or []) %}
            {% set _sts  = (s.get('takeover_status') or '') if s is mapping else (s.takeover_status|default('')) %}
            {% set _ips  = (s.get('ips') or []) if s is mapping else (s.ips or []) %}
            {% if _tags is iterable and _tags is not string and ('non_production' in _tags or 'non-production' in _tags) %}{% set _ = sub_nonprod.append(s) %}{% endif %}
            {% if _tags is iterable and _tags is not string and 'admin_panel' in _tags %}{% set _ = sub_admin.append(s) %}{% endif %}
            {% if _sts in ('VULNERABLE', 'POTENTIAL') %}{% set _ = sub_takeover.append(s) %}{% endif %}
            {% if _ips is iterable and _ips is not string and _ips|length > 0 %}{% set with_ips_count.v = with_ips_count.v + 1 %}{% endif %}
          {% endfor %}
          <div style="font-size:12px;color:var(--text-2);margin-bottom:14px">
            <strong style="color:var(--text-1)">{{ subdomains|length }}</strong> total ¬∑
            <strong>{{ with_ips_count.v }}</strong> resolved ¬∑
            <strong>{{ sub_nonprod|length }}</strong> non-prod ¬∑
            <strong>{{ sub_admin|length }}</strong> admin panels
          </div>
          <div class="toolbar">
            <input type="text" class="filter-input" id="sub-filter"
                   placeholder="Filter subdomains‚Ä¶" oninput="filterTable('sub-table',this.value,0)">
            <button class="btn btn-ghost btn-sm" onclick="copyAllSubdomains()">üìã Copy All</button>
            <button class="btn btn-ghost btn-sm" onclick="location.href='/api/download/{{ scan_id }}/csv_subdomains'">‚¨á CSV</button>
          </div>
          <div class="table-wrap">
            <table class="data-table" id="sub-table">
              <thead><tr>
                <th>Subdomain</th><th>IPs</th><th>Ports</th><th>Tags</th>
                <th>Cloud</th><th>Takeover</th><th>Score</th><th>Sources</th>
              </tr></thead>
              <tbody>
              {% for s in subdomains %}
              {% if s is mapping %}{% set sname = s.get('name') or s.get('subdomain') or s.get('host') or s.get('fqdn') or '' %}{% else %}{% set sname = (s.name or s.subdomain or s.host or s.fqdn)|default('') %}{% endif %}
              {% set _raw_ips = (s.get('ips') or s.get('ip_addresses') or s.get('resolved_ips') or []) if s is mapping else (s.ips or s.ip_addresses or s.resolved_ips or []) %}
              {% set _raw_ports = (s.get('ports') or s.get('open_ports') or []) if s is mapping else (s.ports or s.open_ports or []) %}
              {% set _raw_sources = (s.get('sources') or s.get('source_list') or []) if s is mapping else (s.sources or s.source_list or []) %}
              {# Flatten: if any element is itself a list, unpack it (handles [[ip,...]] nesting) #}
              {% set sips = [] %}{% for _i in (_raw_ips if _raw_ips is iterable and _raw_ips is not string else []) %}{% if _i is string %}{% set _ = sips.append(_i) %}{% elif _i is iterable and _i is not string %}{% for _ii in _i %}{% if _ii is string %}{% set _ = sips.append(_ii) %}{% endif %}{% endfor %}{% endif %}{% endfor %}
              {% set sports = [] %}{% for _p in (_raw_ports if _raw_ports is iterable and _raw_ports is not string else []) %}{% if _p is string or _p is number %}{% set _ = sports.append(_p) %}{% elif _p is iterable and _p is not string %}{% for _pp in _p %}{% if _pp is string or _pp is number %}{% set _ = sports.append(_pp) %}{% endif %}{% endfor %}{% endif %}{% endfor %}
              {% set ssources = [] %}{% for _s in (_raw_sources if _raw_sources is iterable and _raw_sources is not string else []) %}{% if _s is string %}{% set _ = ssources.append(_s) %}{% elif _s is iterable and _s is not string %}{% for _ss in _s %}{% if _ss is string %}{% set _ = ssources.append(_ss) %}{% endif %}{% endfor %}{% endif %}{% endfor %}
              {% set stags = (s.get('tags') or []) if s is mapping else (s.tags or []) %}{% set stags = stags if stags is iterable and stags is not string else [] %}
              {% set sstatus = ((s.get('takeover_status') or s.get('status') or 'UNKNOWN') if s is mapping else (s.takeover_status or s.status or 'UNKNOWN')|default('UNKNOWN'))|string %}
              {% set scloud = ((s.get('cloud_provider') or s.get('cloud') or '') if s is mapping else (s.cloud_provider or s.cloud or '')|default(''))|string %}
              {% set sscore = ((s.get('relevance_score') or s.get('score') or 0) if s is mapping else (s.relevance_score or s.score or 0)|default(0))|int %}
              {% set swild = (s.get('wildcard_candidate') or false) if s is mapping else (s.wildcard_candidate|default(false)) %}
              <tr class="{% if sstatus == 'VULNERABLE' %}sub-vuln{% elif 'non_production' in stags %}sub-nonprod{% elif 'admin_panel' in stags %}sub-admin{% elif 'remote_access' in stags %}sub-remote{% endif %}">
                <td class="mono" style="color:var(--accent-2);font-weight:600">
                  {{ sname }}{% if swild %} <span style="color:var(--warning);font-size:10px">‚òÖ</span>{% endif %}
                </td>
                <td class="mono" style="color:var(--text-2);font-size:11px">{{ sips|join('<br>')|safe or '‚Äî' }}</td>
                <td>
                  {% for p in sports %}{% set pi = p|int %}
                  <span class="port-b {% if pi in [443,8443] %}port-https{% elif pi in [80,8080] %}port-http{% elif pi == 22 %}port-ssh{% elif pi in [21,23,25,445,3306,5432,6379,9200,27017,2375,11211] %}port-danger{% else %}port-other{% endif %}">{{ pi }}</span>
                  {% else %}<span style="color:var(--text-3)">‚Äî</span>{% endfor %}
                </td>
                <td>
                  {% for tag in stags %}
                  {% if tag == 'admin_panel' %}<span class="tag-admin">admin</span>
                  {% elif tag == 'api_endpoint' %}<span class="tag-api">api</span>
                  {% elif tag == 'non_production' %}<span class="tag-nonprod">non-prod</span>
                  {% elif tag == 'remote_access' %}<span class="tag-remote">remote</span>
                  {% elif tag == 'email_infra' %}<span class="tag-email">email</span>
                  {% elif tag == 'devops' %}<span class="tag-devops">devops</span>
                  {% elif tag == 'file_transfer' %}<span class="tag-file">ftp</span>
                  {% elif tag == 'backup' %}<span class="tag-backup">backup</span>
                  {% endif %}
                  {% endfor %}
                </td>
                <td>{% if scloud %}<span class="badge badge-cyan">{{ scloud }}</span>{% else %}<span style="color:var(--text-3)">‚Äî</span>{% endif %}</td>
                <td>
                  {% if sstatus == 'VULNERABLE' %}<span class="sev sev-CRITICAL" style="font-size:10px;animation:critpulse 2s infinite">VULN</span>
                  {% elif sstatus == 'POTENTIAL' %}<span class="sev sev-HIGH" style="font-size:10px">LIKELY</span>
                  {% elif sstatus == 'SAFE' %}<span style="color:var(--text-3)">‚Äî</span>
                  {% else %}<span style="color:var(--text-3)">‚Äî</span>{% endif %}
                </td>
                <td><span style="color:var(--accent);font-family:var(--font-mono);font-size:11px">{{ sscore }}/10</span></td>
                <td style="font-size:11px;color:var(--text-3)">{{ ssources[:2]|join(', ') }}{% if ssources|length > 2 %} +{{ ssources|length - 2 }}{% endif %}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state"><div class="ei">üåê</div>No subdomains found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- EMAILS -->
    <div class="section-card" id="sec-emails">
      <div class="section-header open" onclick="toggleSection('emails')">
        <span class="section-title">üìß Emails</span>
        <span class="section-count">{{ emails|length }}</span>
        <svg class="section-chevron" id="chev-emails" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-emails" data-default="open">
        <div class="section-inner">
          {% if emails %}
          <div class="toolbar">
            <input type="text" class="filter-input" placeholder="Filter emails‚Ä¶" oninput="filterTable('email-table',this.value,0)">
            <button class="btn btn-ghost btn-sm" onclick="copyAllEmails()">üìã Copy All</button>
          </div>
          <div class="table-wrap">
            <table class="data-table" id="email-table">
              <thead><tr><th>Email</th><th>Role</th><th>Sources</th></tr></thead>
              <tbody>
              {% for e in emails %}
              {% set addr = (e.get('email','') if e is mapping else e.email|default('')) %}
              {% set role = (e.get('role_category','generic') if e is mapping else e.role_category|default('generic')) %}
              {% set esrcs = (e.get('sources',[]) if e is mapping else e.sources|default([])) %}
              <tr>
                <td class="mono" style="color:var(--text-1)">{{ addr }}</td>
                <td><span class="badge
                  {% if role == 'security' %}badge-red
                  {% elif role == 'executive' %}badge-purple
                  {% elif role == 'admin' %}badge-orange
                  {% elif role == 'dev' %}badge-blue
                  {% elif role == 'hr' %}badge-green
                  {% elif role == 'finance' %}badge-yellow
                  {% elif role == 'legal' %}badge-indigo
                  {% elif role == 'marketing' %}badge-pink
                  {% else %}badge-gray{% endif %}
                ">{{ role }}</span></td>
                <td style="font-size:11px;color:var(--text-3)">{{ esrcs|join(', ') or '‚Äî' }}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% if email_pattern and email_pattern.pattern %}
          <div style="margin-top:16px;padding:14px 16px;background:var(--bg-3);border:1px solid var(--border-1);border-radius:var(--r2)">
            <div style="font-size:12px;font-weight:700;color:var(--text-1);margin-bottom:8px">
              üìä Detected Pattern: <span class="badge badge-cyan" style="font-family:var(--font-mono)">{{ email_pattern.pattern }}</span>
              <span style="color:var(--text-3);font-size:11px;margin-left:8px">{{ email_pattern.confidence }}% confidence ¬∑ {{ email_pattern.sample_count }} samples</span>
            </div>
            {% if email_pattern.predicted_emails %}
            <div style="font-size:12px;color:var(--text-2);margin-bottom:6px">Predicted format examples:</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap">
              {% for pe in email_pattern.predicted_emails %}
              <span class="badge badge-gray" style="font-family:var(--font-mono)">{{ pe }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endif %}
          {% else %}
          <div class="empty-state"><div class="ei">üìß</div>No emails found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- TECHNOLOGIES -->
    <div class="section-card" id="sec-tech">
      <div class="section-header open" onclick="toggleSection('tech')">
        <span class="section-title">‚öôÔ∏è Technologies</span>
        <span class="section-count">{{ technologies|length }}</span>
        <svg class="section-chevron" id="chev-tech" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-tech" data-default="open">
        <div class="section-inner">
          {% if technologies %}
          {% set tech_by_cat = {} %}
          {% for t in technologies %}
            {% set cat = (t.get('category','other') if t is mapping else t.category|default('other')) %}
            {% if cat not in tech_by_cat %}{% set _ = tech_by_cat.update({cat:[]}) %}{% endif %}
            {% set _ = tech_by_cat[cat].append(t) %}
          {% endfor %}
          {% for cat, techs in tech_by_cat.items() %}
          <div style="margin-bottom:16px">
            <div style="font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;
                        letter-spacing:1px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--border-1)">
              {{ cat|replace('_',' ') }} ({{ techs|length }})
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              {% for t in techs %}
              {% set tname = (t.get('name','') if t is mapping else t.name|default('')) %}
              {% set tconf = (t.get('confidence','') if t is mapping else t.confidence|default('')) %}
              {% set tevid = (t.get('evidence','') if t is mapping else t.evidence|default('')) %}
              <div style="background:var(--bg-3);border:1px solid var(--border-1);border-radius:var(--r1);
                          padding:8px 12px;cursor:default" title="{{ tevid }}">
                <div style="font-size:13px;font-weight:700;color:var(--text-1)">{{ tname }}</div>
                {% if tconf %}<div style="font-size:10px;color:var(--text-3)">{{ tconf }}</div>{% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div class="empty-state"><div class="ei">‚öôÔ∏è</div>No technologies detected.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- DNS -->
    <div class="section-card" id="sec-dns">
      <div class="section-header open" onclick="toggleSection('dns')">
        <span class="section-title">üîç DNS Intelligence</span>
        <span class="section-count">{{ dns_records|length }}</span>
        <svg class="section-chevron" id="chev-dns" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-dns" data-default="open">
        <div class="section-inner">
          {% if dns_records %}
          {% set dmarc_recs = [] %}{% for _dr in (dns_records or []) %}{% set _drt = (_dr.get('type','') if _dr is mapping else _dr.type|default(''))|string %}{% if _drt == 'TXT' %}{% set _ = dmarc_recs.append(_dr) %}{% endif %}{% endfor %}
          {% set has_dmarc = false %}{% set dmarc_policy = '' %}
          {% for rec in dns_records %}
            {% set rval = (rec.get('value','') if rec is mapping else rec.value|default('')) %}
            {% if 'v=DMARC1' in rval %}{% set has_dmarc = true %}
              {% if 'p=reject' in rval %}{% set dmarc_policy = 'reject' %}
              {% elif 'p=quarantine' in rval %}{% set dmarc_policy = 'quarantine' %}
              {% else %}{% set dmarc_policy = 'none' %}{% endif %}
            {% endif %}
          {% endfor %}
          {% if not has_dmarc %}
          <div class="section-alert alert-red">üö® NO DMARC ‚Äî This domain can be used for email spoofing attacks</div>
          {% elif dmarc_policy == 'none' %}
          <div class="section-alert alert-yellow">‚ö†Ô∏è DMARC is monitoring only (p=none) ‚Äî upgrade to p=quarantine or p=reject</div>
          {% elif dmarc_policy in ('quarantine','reject') %}
          <div class="section-alert alert-blue">‚úÖ DMARC enforced: p={{ dmarc_policy }}</div>
          {% endif %}
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Type</th><th>Name</th><th>Value</th></tr></thead>
              <tbody>
              {% for rec in dns_records %}
              {% set rtype = (rec.get('type','') if rec is mapping else rec.type|default('')) %}
              {% set rname = (rec.get('name','') if rec is mapping else rec.name|default('')) %}
              {% set rval = (rec.get('value','') if rec is mapping else rec.value|default('')) %}
              <tr>
                <td><span class="badge dns-{{ rtype }}">{{ rtype }}</span></td>
                <td class="mono" style="color:var(--text-2);font-size:11px">{{ rname }}</td>
                <td class="mono" style="font-size:11px;word-break:break-all;max-width:400px">{{ rval }}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state"><div class="ei">üîç</div>No DNS records found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- WHOIS -->
    <div class="section-card" id="sec-whois">
      <div class="section-header" onclick="toggleSection('whois')">
        <span class="section-title">üìã WHOIS</span>
        <svg class="section-chevron rotated" id="chev-whois" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-whois" style="max-height:0">
        <div class="section-inner">
          {% if whois_data %}
          <div class="kv-grid">
            {% for k, v in whois_data.items() %}{% if k != 'source' and v %}
            <div class="kv-key">{{ k|replace('_',' ')|title }}</div>
            <div class="kv-val">{{ v }}</div>
            {% endif %}{% endfor %}
          </div>
          {% else %}
          <div class="empty-state"><div class="ei">üìã</div>No WHOIS data.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- IP INTELLIGENCE -->
    <div class="section-card" id="sec-ip">
      <div class="section-header open" onclick="toggleSection('ip')">
        <span class="section-title">üñ•Ô∏è IP / ASN Intelligence</span>
        <span class="section-count">{{ ip_records|length }}</span>
        <svg class="section-chevron" id="chev-ip" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-ip" data-default="open">
        <div class="section-inner">
          {% if ip_records %}
          <div style="display:flex;flex-direction:column;gap:12px">
          {% for ip in ip_records %}
          {% set iip = (ip.get('ip','') if ip is mapping else ip.ip|default('')) %}
          {% set icountry = (ip.get('country','') if ip is mapping else ip.country|default('')) %}
          {% set icity = (ip.get('city','') if ip is mapping else ip.city|default('')) %}
          {% set iasn = (ip.get('asn','') if ip is mapping else ip.asn|default('')) %}
          {% set iorg = (ip.get('org','') if ip is mapping else ip.org|default('')) %}
          {% set irdns = (ip.get('rdns','') if ip is mapping else ip.rdns|default('')) %}
          {% set icloud = (ip.get('cloud_provider','') if ip is mapping else ip.cloud_provider|default('')) %}
          {% set icdn = (ip.get('cdn',false) if ip is mapping else ip.cdn|default(false)) %}
          {% set iports = (ip.get('open_ports',[]) if ip is mapping else ip.open_ports|default([])) %}
          {% set ivulns = (ip.get('vulns',[]) if ip is mapping else ip.vulns|default([])) %}
          {% set icpes = (ip.get('cpes',[]) if ip is mapping else ip.cpes|default([])) %}
          {% set itags = (ip.get('tags',[]) if ip is mapping else ip.tags|default([])) %}
          {% set ign = (ip.get('greynoise',{}) if ip is mapping else ip.greynoise|default({})) %}
          {% set iabuse = (ip.get('abuseipdb',{}) if ip is mapping else ip.abuseipdb|default({})) %}
          {% set iotx = (ip.get('otx_data',{}) if ip is mapping else ip.otx_data|default({})) %}
          {% set ishared = (ip.get('shared_hosting',[]) if ip is mapping else ip.shared_hosting|default([])) %}
          {% set ignnoise = (ign.get('noise',false) if ign is mapping else false) %}
          {% set ignclass = (ign.get('classification','') if ign is mapping else '') %}
          {% set iabscore = (iabuse.get('abuse_score',0) if iabuse is mapping else 0)|int %}
          {% set iotxpulses = (iotx.get('pulse_count',0) if iotx is mapping else 0)|int %}
          <div class="ip-card {% if ignnoise or iabscore > 50 or iotxpulses > 5 %}ip-card-threat{% elif ivulns %}ip-card-vuln{% endif %}">
            <div class="ip-card-header">
              <div class="ip-addr">{{ iip }}</div>
              <div class="ip-badges">
                {% if icloud or icdn %}<span class="badge badge-cyan">{{ icloud or 'CDN' }}</span>{% endif %}
                {% if iasn %}<span class="badge badge-gray">AS{{ iasn }}</span>{% endif %}
                {% if ignnoise %}<span class="badge badge-red">GreyNoise: {{ ignclass or 'Noisy' }}</span>{% endif %}
                {% if iabscore > 50 %}<span class="badge badge-red">Abuse: {{ iabscore }}%</span>
                {% elif iabscore > 20 %}<span class="badge badge-yellow">Abuse: {{ iabscore }}%</span>{% endif %}
                {% if iotxpulses > 0 %}<span class="badge badge-orange">OTX: {{ iotxpulses }} pulses</span>{% endif %}
                {% if ivulns %}<span class="badge badge-red">{{ ivulns|length }} CVE{% if ivulns|length > 1 %}s{% endif %}</span>{% endif %}
              </div>
            </div>
            <div class="ip-card-body">
              <div class="ip-meta-grid">
                {% if icountry or icity %}<div><span class="ip-ml">üìç Location</span> {{ icity }}{% if icity and icountry %}, {% endif %}{{ icountry }}</div>{% endif %}
                {% if iorg %}<div><span class="ip-ml">üè¢ Org</span> {{ iorg[:50] }}</div>{% endif %}
                {% if irdns %}<div><span class="ip-ml">üîÑ rDNS</span> <span class="mono" style="font-size:11px">{{ irdns }}</span></div>{% endif %}
              </div>
              {% if iports %}
              <div style="margin-top:10px">
                <span class="ip-ml">üîå Ports</span>
                {% for p in iports %}{% set pi = p|int %}
                <span class="port-b {% if pi in [443,8443] %}port-https{% elif pi in [80,8080] %}port-http{% elif pi == 22 %}port-ssh{% elif pi in [21,23,25,445,3306,5432,6379,9200,27017,2375,11211] %}port-danger{% else %}port-other{% endif %}">{{ pi }}</span>
                {% endfor %}
              </div>
              {% endif %}
              {% if ivulns %}
              <div style="margin-top:8px;font-size:11px">
                <span class="ip-ml">üî¥ CVEs</span>
                {% for v in ivulns[:8] %}<span class="badge badge-red" style="font-size:10px;margin:1px">{{ v }}</span>{% endfor %}
                {% if ivulns|length > 8 %}<span style="color:var(--text-3)">+{{ ivulns|length - 8 }} more</span>{% endif %}
              </div>
              {% endif %}
              {% if icpes %}
              <div style="margin-top:6px;font-size:10px;color:var(--text-3)">
                <span class="ip-ml">üì¶ CPEs</span> {{ icpes[:3]|join(' ¬∑ ') }}
              </div>
              {% endif %}
              {% if itags %}
              <div style="margin-top:6px">
                {% for tag in itags %}<span class="badge badge-gray" style="font-size:10px;margin:1px">{{ tag }}</span>{% endfor %}
              </div>
              {% endif %}
              {% if ishared %}
              <div style="margin-top:8px;font-size:11px;color:var(--warning)" title="{{ ishared|join('\n') }}">
                üèòÔ∏è Shared hosting: {{ ishared|length }} other domains
                {% if ishared|length <= 5 %}({{ ishared|join(', ') }}){% endif %}
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
          </div>
          {% else %}
          <div class="empty-state"><div class="ei">üñ•Ô∏è</div>No IP records found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- SSL/TLS -->
    <div class="section-card" id="sec-ssl">
      <div class="section-header" onclick="toggleSection('ssl')">
        <span class="section-title">üîí SSL / TLS</span>
        <span class="section-count">{{ ssl_info|length }}</span>
        <svg class="section-chevron rotated" id="chev-ssl" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-ssl" style="max-height:0">
        <div class="section-inner">
          {% if ssl_info %}
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Subject</th><th>Issuer</th><th>Valid Until</th><th>Days Left</th><th>Status</th></tr></thead>
              <tbody>
              {% for cert in ssl_info %}
              {% set csubj = (cert.get('subject','') if cert is mapping else cert.subject|default('')) %}
              {% set ciss = (cert.get('issuer','') if cert is mapping else cert.issuer|default('')) %}
              {% set cexp = (cert.get('not_after','') if cert is mapping else cert.not_after|default('')) %}
              {% set cdays = (cert.get('days_left',0) if cert is mapping else cert.days_left|default(0)) %}
              {% set cexpired = (cert.get('expired',false) if cert is mapping else cert.expired|default(false)) %}
              <tr>
                <td class="mono" style="font-size:11px;color:var(--text-1)">{{ csubj[:50] }}</td>
                <td style="font-size:12px;color:var(--text-2)">{{ ciss[:30] }}</td>
                <td class="mono" style="font-size:11px;color:var(--text-3)">{{ cexp[:10] }}</td>
                <td class="mono" style="color:{% if cexpired %}var(--danger){% elif cdays < 30 %}var(--warning){% else %}var(--success){% endif %}">{{ cdays }}</td>
                <td>{% if cexpired %}<span class="badge badge-red">EXPIRED</span>
                    {% elif cdays < 30 %}<span class="badge badge-yellow">EXPIRING</span>
                    {% else %}<span class="badge badge-green">VALID</span>{% endif %}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state"><div class="ei">üîí</div>No SSL certificates found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- SECURITY HEADERS -->
    <div class="section-card" id="sec-headers">
      <div class="section-header" onclick="toggleSection('headers')">
        <span class="section-title">üîê Security Headers</span>
        {% if security_headers %}
        <span class="section-count">Grade: {{ security_headers.get('grade','?') }}</span>
        {% endif %}
        <svg class="section-chevron rotated" id="chev-headers" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-headers" style="max-height:0">
        <div class="section-inner">
          {% if security_headers %}
          <div style="display:flex;gap:20px;align-items:center;margin-bottom:18px">
            {% set grade = security_headers.get('grade','F') %}
            <div class="grade-display grade-{{ grade[0] }}">{{ grade }}</div>
            <div>
              <div style="font-size:16px;font-weight:800;color:var(--text-1)">Score: {{ security_headers.get('score',0) }}/100</div>
              <div style="font-size:12px;color:var(--text-2)">{{ security_headers.get('headers_present',[])|length }} headers present ¬∑ {{ security_headers.get('headers_missing',[])|length }} missing</div>
            </div>
          </div>
          {% for hdr in ['Content-Security-Policy','Strict-Transport-Security','X-Frame-Options','X-Content-Type-Options','Referrer-Policy','Permissions-Policy'] %}
          {% set hpresent = hdr in (security_headers.get('headers_present',[]) or []) %}
          {% set hval = security_headers.get('details',{}).get(hdr,'') if security_headers.get('details') else '' %}
          <div class="header-row">
            <span class="{% if hpresent %}check-ok{% else %}check-miss{% endif %}">{% if hpresent %}‚úÖ{% else %}‚ùå{% endif %}</span>
            <span class="hrow-name">{{ hdr }}</span>
            <span class="hrow-val">{{ hval[:80] if hval else ('Missing' if not hpresent else '') }}</span>
          </div>
          {% endfor %}
          {% else %}
          <div class="empty-state"><div class="ei">üîê</div>Security headers not analyzed.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- WEB ARCHIVE -->
    <div class="section-card" id="sec-archive">
      <div class="section-header" onclick="toggleSection('archive')">
        <span class="section-title">üì¶ Web Archive</span>
        {% if wayback %}
        <span class="section-count">{{ wayback.get('total_urls', wayback.get('interesting',[])|length) }} URLs</span>
        {% endif %}
        <svg class="section-chevron rotated" id="chev-archive" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-archive" style="max-height:0">
        <div class="section-inner">
          {% if wayback %}
          {% set interesting = wayback.get('interesting_urls', wayback.get('interesting', [])) %}
          {% set api_endpoints = wayback.get('api_endpoints', []) %}
          {% set sensitive_files = wayback.get('sensitive_files', []) %}
          {% set robots_disallow = wayback.get('robots_disallow', []) %}
          {% set sitemap_urls = wayback.get('sitemap_urls', []) %}
          {% set total_archived = wayback.get('total_urls', (wayback.get('all', []) or [])|length) %}
          <!-- Stats bar -->
          <div style="display:flex;gap:20px;flex-wrap:wrap;font-size:12px;color:var(--text-2);margin-bottom:16px;
                      padding:12px 16px;background:var(--bg-3);border:1px solid var(--border-1);border-radius:var(--r1)">
            <span>üì¶ <strong style="color:var(--text-1)">{{ total_archived }}</strong> total URLs</span>
            <span>‚ö†Ô∏è <strong style="color:var(--warning)">{{ interesting|length }}</strong> interesting</span>
            {% if sensitive_files %}<span>üî¥ <strong style="color:var(--danger)">{{ sensitive_files|length }}</strong> sensitive files</span>{% endif %}
            {% if api_endpoints %}<span>üîµ <strong style="color:var(--accent)">{{ api_endpoints|length }}</strong> API endpoints</span>{% endif %}
            {% if robots_disallow %}<span>ü§ñ <strong style="color:var(--text-1)">{{ robots_disallow|length }}</strong> robots.txt paths</span>{% endif %}
          </div>
          {% if sensitive_files %}
          <div class="section-alert alert-red" style="margin-bottom:12px">üö® {{ sensitive_files|length }} sensitive files found in Wayback archive</div>
          <div class="table-wrap" style="margin-bottom:14px">
            <table class="data-table">
              <thead><tr><th>Sensitive File</th><th>Type</th></tr></thead>
              <tbody>
              {% for sf in sensitive_files[:30] %}
              {% set sfstr = (sf if sf is string else sf.get('url',sf))|string %}
              <tr>
                <td class="mono" style="font-size:11px;word-break:break-all;max-width:500px">
                  <a href="{{ sfstr }}" target="_blank" style="color:var(--danger)">{{ sfstr[:120] }}</a>
                </td>
                <td>
                  {% set sl = sfstr|lower %}
                  {% if '.env' in sl %}<span class="badge badge-red">.env</span>
                  {% elif '.sql' in sl %}<span class="badge badge-red">.sql</span>
                  {% elif 'backup' in sl or '.bak' in sl %}<span class="badge badge-orange">backup</span>
                  {% elif 'config' in sl %}<span class="badge badge-orange">config</span>
                  {% elif 'admin' in sl %}<span class="badge badge-yellow">admin panel</span>
                  {% elif 'phpmyadmin' in sl %}<span class="badge badge-red">phpMyAdmin</span>
                  {% elif '.htaccess' in sl or '.htpasswd' in sl %}<span class="badge badge-red">auth config</span>
                  {% elif '.yml' in sl or '.yaml' in sl %}<span class="badge badge-orange">yaml config</span>
                  {% elif '.git' in sl %}<span class="badge badge-red">.git</span>
                  {% else %}<span class="badge badge-gray">sensitive</span>{% endif %}
                </td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
          {% if api_endpoints %}
          <div style="margin-bottom:14px">
            <div style="font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">
              üîµ Discovered API Endpoints ({{ api_endpoints|length }})
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:4px">
              {% for ep in api_endpoints[:30] %}
              <span class="badge badge-blue" style="font-family:var(--font-mono);font-size:10px">{{ ep[:60] }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% if robots_disallow %}
          <div style="margin-bottom:14px">
            <div style="font-size:11px;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">
              ü§ñ robots.txt Disallowed Paths
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:4px">
              {% for path in robots_disallow[:20] %}
              <span class="badge badge-gray" style="font-family:var(--font-mono);font-size:10px">{{ path[:50] }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
          {% if interesting and not sensitive_files %}
          <div class="section-alert alert-yellow" style="margin-bottom:12px">‚ö†Ô∏è {{ interesting|length }} interesting URLs found in archive</div>
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>URL</th><th>Flags</th></tr></thead>
              <tbody>
              {% for url in interesting[:30] %}
              <tr>
                <td class="mono" style="font-size:11px;word-break:break-all;max-width:500px">
                  <a href="{{ url if url is string else url.get('url',url) }}" target="_blank" style="color:var(--accent)">
                    {{ (url if url is string else url.get('url','')) [:100] }}
                  </a>
                </td>
                <td>
                  {% set ustr = (url if url is string else url.get('url',''))|lower %}
                  {% if '.env' in ustr %}<span class="badge badge-red">.env</span>{% endif %}
                  {% if 'backup' in ustr or '.bak' in ustr %}<span class="badge badge-orange">backup</span>{% endif %}
                  {% if 'admin' in ustr %}<span class="badge badge-yellow">admin</span>{% endif %}
                  {% if 'config' in ustr %}<span class="badge badge-orange">config</span>{% endif %}
                  {% if '/api/' in ustr %}<span class="badge badge-blue">api</span>{% endif %}
                </td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% elif not interesting and not sensitive_files %}
          <div style="font-size:12px;color:var(--text-2)">Archive crawled. No sensitive URLs found.</div>
          {% endif %}
          {% else %}
          <div class="empty-state"><div class="ei">üì¶</div>No archive data.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- BREACHES -->
    <div class="section-card" id="sec-breach">
      <div class="section-header" onclick="toggleSection('breach')">
        <span class="section-title">üö® Breach Intelligence</span>
        <span class="section-count {% if breach_records %}section-count-red{% endif %}">{{ breach_records|length }}</span>
        <svg class="section-chevron rotated" id="chev-breach" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-breach" style="max-height:0">
        <div class="section-inner">
          {% if breach_records %}
          <div class="section-alert alert-red">üîì Domain found in {{ breach_records|length }} data breach(es)</div>
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Breach</th><th>Date</th><th>Data Types</th></tr></thead>
              <tbody>
              {% for b in breach_records %}
              {% set bname = (b.get('name','') if b is mapping else b.name|default('')) %}
              {% set bdate = (b.get('date','') if b is mapping else b.date|default('')) %}
              {% set bdtypes = (b.get('data_types',[]) if b is mapping else b.data_types|default([])) %}
              <tr>
                <td style="font-weight:700;color:var(--text-1)">{{ bname }}</td>
                <td class="mono" style="color:var(--text-3)">{{ bdate[:10] if bdate else '?' }}</td>
                <td>
                  {% for dt in bdtypes %}
                  <span class="badge {% if dt in ['Passwords','Email addresses'] %}badge-red{% else %}badge-gray{% endif %}" style="margin:1px">{{ dt }}</span>
                  {% endfor %}
                </td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state"><div class="ei">‚úÖ</div>No breach records found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- CLOUD ASSETS -->
    <div class="section-card" id="sec-cloud">
      <div class="section-header" onclick="toggleSection('cloud')">
        <span class="section-title">‚òÅÔ∏è Cloud Exposure</span>
        <span class="section-count">{{ cloud_assets|length }}</span>
        <svg class="section-chevron rotated" id="chev-cloud" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-cloud" style="max-height:0">
        <div class="section-inner">
          {% if cloud_assets %}
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Type</th><th>Name</th><th>URL</th><th>Public</th></tr></thead>
              <tbody>
              {% for a in cloud_assets %}
              {% set atype = (a.get('asset_type','') if a is mapping else a.asset_type|default('')) %}
              {% set aname = (a.get('name','') if a is mapping else a.name|default('')) %}
              {% set aurl = (a.get('url','') if a is mapping else a.url|default('')) %}
              {% set apub = (a.get('public',false) if a is mapping else a.public|default(false)) %}
              <tr>
                <td><span class="badge badge-cyan">{{ atype }}</span></td>
                <td class="mono" style="font-size:11px;color:var(--text-1)">{{ aname }}</td>
                <td class="mono" style="font-size:11px;color:var(--text-3)">{{ aurl[:60] }}</td>
                <td>{% if apub %}<span class="badge badge-red">PUBLIC</span>{% else %}<span class="badge badge-green">PRIVATE</span>{% endif %}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state"><div class="ei">‚òÅÔ∏è</div>No cloud assets found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- TAKEOVER -->
    <div class="section-card" id="sec-takeover">
      <div class="section-header" onclick="toggleSection('takeover')">
        <span class="section-title">üé≠ Subdomain Takeover</span>
        <span class="section-count {% if vuln_takeovers %}section-count-red{% endif %}">{{ takeover_records|length }}</span>
        <svg class="section-chevron rotated" id="chev-takeover" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-takeover" style="max-height:0">
        <div class="section-inner">
          {% if takeover_records %}
          {% if vuln_takeovers %}
          <div class="section-alert alert-red">üö® {{ vuln_takeovers|length }} subdomain(s) CONFIRMED vulnerable to takeover!</div>
          {% endif %}
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Subdomain</th><th>Status</th><th>Provider</th><th>CNAME Chain</th></tr></thead>
              <tbody>
              {% for t in takeover_records %}
              {% set tsub = (t.get('subdomain','') if t is mapping else t.subdomain|default('')) %}
              {% set tstatus = (t.get('status','') if t is mapping else t.status|default('')) %}
              {% set tprov = (t.get('provider','') if t is mapping else t.provider|default('')) %}
              {% set tcchain = (t.get('cname_chain',[]) if t is mapping else t.cname_chain|default([])) %}
              <tr>
                <td class="mono" style="color:var(--accent)">{{ tsub }}</td>
                <td><span class="sev sev-{% if tstatus == 'VULNERABLE' %}CRITICAL{% elif tstatus == 'LIKELY_VULNERABLE' %}HIGH{% else %}MEDIUM{% endif %}">{{ tstatus }}</span></td>
                <td><span class="badge badge-orange">{{ tprov }}</span></td>
                <td class="mono" style="font-size:11px;color:var(--text-3)">{{ tcchain|join(' ‚Üí ') }}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state"><div class="ei">‚úÖ</div>No takeover candidates found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- REPUTATION -->
    <div class="section-card" id="sec-rep">
      <div class="section-header" onclick="toggleSection('rep')">
        <span class="section-title">üè∑Ô∏è Reputation</span>
        <svg class="section-chevron rotated" id="chev-rep" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-rep" style="max-height:0">
        <div class="section-inner">
          {% if reputation_data %}
          {% for source, data in reputation_data.items() %}
          <div style="margin-bottom:12px;padding:12px 14px;background:var(--bg-3);border:1px solid var(--border-1);border-radius:var(--r2)">
            <div style="font-size:12px;font-weight:700;color:var(--text-1);margin-bottom:6px;text-transform:capitalize">{{ source }}</div>
            {% if data is mapping %}
            {% for k, v in data.items() %}
            <div style="font-size:12px;color:var(--text-2)"><span style="color:var(--text-3)">{{ k }}:</span> {{ v }}</div>
            {% endfor %}
            {% else %}
            <div style="font-size:12px;color:var(--text-2)">{{ data }}</div>
            {% endif %}
          </div>
          {% endfor %}
          {% else %}
          <div class="empty-state"><div class="ei">üè∑Ô∏è</div>No reputation data.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- SOCIAL -->
    <div class="section-card" id="sec-social">
      <div class="section-header" onclick="toggleSection('social')">
        <span class="section-title">üë• Social Footprint</span>
        <svg class="section-chevron rotated" id="chev-social" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-social" style="max-height:0">
        <div class="section-inner">
          {% if social %}
          <div style="display:flex;gap:10px;flex-wrap:wrap">
          {% for platform, url in (social.get('profiles',{}) or {}).items() %}
          <a href="{{ url }}" target="_blank" class="badge badge-blue">{{ platform }}</a>
          {% endfor %}
          </div>
          {% if social.get('company') %}
          <div style="margin-top:12px;font-size:13px;color:var(--text-2)">{{ social.company }}</div>
          {% endif %}
          {% else %}
          <div class="empty-state"><div class="ei">üë•</div>No social footprint found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- TYPOSQUATTING -->
    <div class="section-card" id="sec-typo">
      <div class="section-header" onclick="toggleSection('typo')">
        <span class="section-title">üî§ Typosquatting</span>
        <span class="section-count">{{ typosquats|length }}</span>
        <svg class="section-chevron rotated" id="chev-typo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
      </div>
      <div class="section-body" id="sbody-typo" style="max-height:0">
        <div class="section-inner">
          {% if typosquats %}
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Domain</th><th>Type</th><th>Status</th><th>IP</th></tr></thead>
              <tbody>
              {% for t in typosquats %}
              {% set tdomain = (t.get('domain','') if t is mapping else t.domain|default('')) %}
              {% set ttype = (t.get('type','') if t is mapping else t.type|default('')) %}
              {% set tstatus = (t.get('status','') if t is mapping else t.status|default('')) %}
              {% set tip = (t.get('ip','') if t is mapping else t.ip|default('')) %}
              <tr>
                <td class="mono" style="color:var(--text-1)">{{ tdomain }}</td>
                <td><span class="badge badge-gray">{{ ttype }}</span></td>
                <td><span class="badge {% if 'active' in tstatus|lower or 'registered' in tstatus|lower %}badge-red{% else %}badge-gray{% endif %}">{{ tstatus }}</span></td>
                <td class="mono" style="font-size:11px;color:var(--text-3)">{{ tip or '‚Äî' }}</td>
              </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state"><div class="ei">üî§</div>No typosquats found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="footer">Ghost Recon Tool ¬∑ Passive OSINT Platform ¬∑ created by mnt0x ¬∑ <a href="/api/debug/{{ scan_id }}" target="_blank" style="color:var(--text-3)">Debug JSON</a></div>
  </main>
</div>
{% endif %}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
{% if page != "results_fragment" %}
<script>
// ‚îÄ‚îÄ DOM helpers ‚îÄ‚îÄ
function $(id){return document.getElementById(id)}
function qsa(sel,root){return (root||document).querySelectorAll(sel)}

// ‚îÄ‚îÄ Home: particle canvas ‚îÄ‚îÄ
{% if page == "home" %}
(function(){
  const canvas=$('particle-canvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H,nodes=[];
  function resize(){W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight}
  resize();
  window.addEventListener('resize',resize);
  for(let i=0;i<60;i++)nodes.push({
    x:Math.random()*W,y:Math.random()*H,
    vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.3,
    r:Math.random()*2+1
  });
  function draw(){
    ctx.clearRect(0,0,W,H);
    nodes.forEach(n=>{
      n.x+=n.vx;n.y+=n.vy;
      if(n.x<0||n.x>W)n.vx*=-1;
      if(n.y<0||n.y>H)n.vy*=-1;
      ctx.beginPath();ctx.arc(n.x,n.y,n.r,0,Math.PI*2);
      ctx.fillStyle='rgba(59,130,246,0.4)';ctx.fill();
    });
    for(let i=0;i<nodes.length;i++)
      for(let j=i+1;j<nodes.length;j++){
        const dx=nodes[i].x-nodes[j].x,dy=nodes[i].y-nodes[j].y;
        const d=Math.sqrt(dx*dx+dy*dy);
        if(d<120){
          ctx.beginPath();ctx.moveTo(nodes[i].x,nodes[i].y);ctx.lineTo(nodes[j].x,nodes[j].y);
          ctx.strokeStyle=`rgba(59,130,246,${0.1*(1-d/120)})`;ctx.stroke();
        }
      }
    requestAnimationFrame(draw);
  }
  draw();
})();

// ‚îÄ‚îÄ Domain validation ‚îÄ‚îÄ
let selectedMode='balanced';
function validateDomain(input){
  const v=input.value.trim();
  const valid=/^(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/.test(v);
  const icon=$('domain-valid-icon');
  if(v.length===0){icon.textContent='';input.style.borderColor=''}
  else if(valid){icon.textContent='‚úÖ';input.style.borderColor='var(--success)'}
  else{icon.textContent='‚ùå';input.style.borderColor='var(--danger)'}
  $('launch-btn').disabled=!valid;
}
function selectMode(m){
  selectedMode=m;
  qsa('.mode-card').forEach(c=>c.classList.remove('selected'));
  document.querySelector(`[data-mode="${m}"]`).classList.add('selected');
}
document.addEventListener('keydown',function(e){
  if(e.key==='Enter'&&$('domain-input')===document.activeElement&&!$('launch-btn').disabled)launchScan();
});

// ‚îÄ‚îÄ Launch scan ‚îÄ‚îÄ
function launchScan(){
  const domain=$('domain-input').value.trim();
  if(!domain)return;
  const overlay=$('scan-overlay');
  overlay.classList.add('visible');
  $('overlay-domain').textContent=domain;
  $('overlay-mode-badge').textContent=selectedMode.toUpperCase();
  $('home-page').style.display='none';
  startScan(domain,selectedMode);
}

// ‚îÄ‚îÄ SSE Scanning ‚îÄ‚îÄ
let scanStart=Date.now(),timerInterval;
const MODULE_MAP={
  'DNS Intelligence':'dns','Subdomain Enumeration':'subdomains',
  'Email Discovery':'emails','Technology Detection':'tech',
  'WHOIS Intelligence':'whois','IP Intelligence':'ip',
  'SSL Intelligence':'ssl','Web Archive':'archive',
  'Breach Intelligence':'breach','Reputation Intel':'rep',
  'Cloud Assets':'cloud','Takeover Detection':'takeover',
  'Typosquat Detection':'typo','Security Headers':'headers',
  'Social Footprint':'social','ASN Intelligence':'asn',
  'Vulnerability Intelligence':'vulns','Risk Scoring':'score',
  'Correlations':'corr'
};
function logLine(cls,text){
  const body=$('console-log');
  const d=document.createElement('div');
  d.className='cl-'+cls;d.textContent=text;
  body.appendChild(d);
  if(body.children.length>200)body.removeChild(body.children[0]);
  body.scrollTop=body.scrollHeight;
}
function setModuleStatus(key,status,count){
  const card=$('mod-'+key),si=$('mods-'+key);
  if(!card||!si)return;
  if(status==='running'){card.className='module-card running';si.textContent='üîÑ'}
  else if(status==='done'){card.className='module-card done';si.textContent=count!=null?'‚úÖ '+count:'‚úÖ'}
  else if(status==='failed'){card.className='module-card failed';si.textContent='‚ùå'}
}
function animCount(id,target){
  const el=$(id);if(!el)return;
  const cur=parseInt(el.textContent)||0;
  if(target<=cur)return;
  const step=Math.ceil((target-cur)/12);
  let v=cur;
  const t=setInterval(()=>{v=Math.min(v+step,target);el.textContent=v;if(v>=target)clearInterval(t)},50);
}
function updateProgress(pct){
  const bar=$('overlay-bar'),lbl=$('overlay-pct');
  if(bar)bar.style.width=pct+'%';
  if(lbl)lbl.textContent=pct+'%';
}
let modulesDone=0,totalModules=16;
function startScan(domain,mode){
  scanStart=Date.now();
  timerInterval=setInterval(()=>{
    const elapsed=Math.floor((Date.now()-scanStart)/1000);
    const m=String(Math.floor(elapsed/60)).padStart(2,'0');
    const s=String(elapsed%60).padStart(2,'0');
    const t=$('overlay-timer');if(t)t.textContent=m+':'+s;
  },1000);
  const url=`/scan/stream?domain=${encodeURIComponent(domain)}&mode=${mode}`;
  const es=new EventSource(url);
  es.addEventListener('start',()=>{logLine('info','[*] Scan started for '+domain);updateProgress(2)});
  es.addEventListener('phase',e=>{
    const d=JSON.parse(e.data);
    const key=MODULE_MAP[d.name]||d.name.toLowerCase().replace(/\s+/g,'-');
    if(d.status==='running'){setModuleStatus(key,'running');logLine('info','[*] '+d.name+'...')}
    else if(d.status==='done'){
      modulesDone++;
      setModuleStatus(key,'done',d.count);
      updateProgress(Math.min(95,Math.round((modulesDone/totalModules)*100)));
      if(d.count>0)logLine('plus','[+] '+d.name+' ‚Üí '+d.count+' found');
    }
  });
  es.addEventListener('log',e=>{
    const d=JSON.parse(e.data);
    const lvl=(d.level||'').toLowerCase();
    if(lvl.includes('!!!!'))logLine('crit','[!!!] '+d.message);
    else if(lvl.includes('!'))logLine('warn','[!] '+d.message);
    else if(lvl.includes('+'))logLine('plus','[+] '+d.message);
    else logLine('info','[*] '+d.message);
  });
  es.addEventListener('saved',e=>{
    const d=JSON.parse(e.data);
    clearInterval(timerInterval);
    updateProgress(100);
    logLine('plus','[+] Scan complete! Loading results...');
    es.close();
    setTimeout(()=>loadResults(d.scan_id),800);
  });
  es.addEventListener('error',e=>{
    const d=JSON.parse(e.data||'{}');
    clearInterval(timerInterval);
    logLine('minus','[-] Error: '+(d.message||'Unknown error'));
    es.close();
  });
  // Handle numeric count updates from complete event
  es.addEventListener('complete',e=>{
    const d=JSON.parse(e.data);
    const s=d.summary||{};
    if(s.subdomains!=null)animCount('cnt-subs',s.subdomains);
    if(s.emails!=null)animCount('cnt-emails',s.emails);
    if(s.ip_records!=null)animCount('cnt-ips',s.ip_records);
    if(s.vulnerabilities!=null)animCount('cnt-vulns',s.vulnerabilities);
    logLine('plus','[+] Done! '+s.subdomains+' subs ¬∑ '+s.emails+' emails ¬∑ '+s.vulnerabilities+' vulns');
  });
}
function loadResults(scanId){
  fetch('/api/result-fragment/'+scanId)
    .then(r=>{if(!r.ok)throw new Error('HTTP '+r.status);return r.text();})
    .then(html=>{
      const overlay=$('scan-overlay');
      overlay.style.transition='opacity .5s';
      overlay.style.opacity='0';
      setTimeout(()=>{
        overlay.classList.remove('visible');
        overlay.style.opacity='';
        document.body.insertAdjacentHTML('beforeend',html);
        window.scrollTo({top:0,behavior:'smooth'});
        initSections();
        initSidebarScroll();
        initDropdowns();
      },500);
    })
    .catch(err=>{
      logLine('minus','[-] Failed to load results: '+(err.message||'unknown error'));
      const overlay=$('scan-overlay');
      overlay.style.transition='opacity .5s';
      overlay.style.opacity='0';
      setTimeout(()=>{
        overlay.classList.remove('visible');
        overlay.style.opacity='';
        document.body.insertAdjacentHTML('beforeend',
          '<div style="position:fixed;inset:0;z-index:100;background:var(--bg-1);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px">'
          +'<div style="color:var(--danger);font-size:1.5rem;font-weight:700">‚ö† Results Load Failed</div>'
          +'<div style="color:var(--text-2)">The scan completed but the results page failed to render.</div>'
          +'<div style="display:flex;gap:12px">'
          +'<a href="/results/'+scanId+'" style="padding:10px 20px;background:var(--accent);color:#fff;border-radius:8px;font-weight:600">View Results Page</a>'
          +'<a href="/history" style="padding:10px 20px;background:var(--bg-3);color:var(--text-2);border:1px solid var(--border-1);border-radius:8px">History</a>'
          +'</div></div>');
      },500);
    });
}
{% endif %}

// ‚îÄ‚îÄ Section collapse ‚îÄ‚îÄ
function toggleSection(key){
  const body=$('sbody-'+key),chev=$('chev-'+key),hdr=body?body.previousElementSibling:null;
  if(!body)return;
  const isOpen=body.style.maxHeight&&body.style.maxHeight!=='0px';
  if(isOpen){body.style.maxHeight='0px';if(chev)chev.classList.add('rotated');if(hdr)hdr.classList.remove('open')}
  else{body.style.maxHeight=body.scrollHeight+200+'px';if(chev)chev.classList.remove('rotated');if(hdr)hdr.classList.add('open')}
}
function initSections(){
  qsa('.section-body').forEach(body=>{
    const isOpen=body.dataset.default==='open'||body.previousElementSibling?.classList.contains('open');
    if(isOpen)body.style.maxHeight=body.scrollHeight+200+'px';
    else body.style.maxHeight='0px';
  });
}
document.addEventListener('DOMContentLoaded',()=>{initSections();initSidebarScroll();initDropdowns()});

// ‚îÄ‚îÄ Sidebar scroll spy ‚îÄ‚îÄ
function scrollTo(id){
  const el=document.getElementById(id);
  if(el)el.scrollIntoView({behavior:'smooth',block:'start'});
  return false;
}
function initSidebarScroll(){
  const sections=qsa('[id^="sec-"]');
  const links=qsa('.sb-link');
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(en=>{
      if(en.isIntersecting){
        links.forEach(l=>l.classList.remove('active'));
        const lnk=document.querySelector(`.sb-link[href="#${en.target.id}"]`);
        if(lnk)lnk.classList.add('active');
      }
    });
  },{rootMargin:'-20% 0px -70% 0px',threshold:0});
  sections.forEach(s=>obs.observe(s));
}

// ‚îÄ‚îÄ Vulnerability filter ‚îÄ‚îÄ
function filterVulns(sev,btn){
  qsa('.vfilt').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  qsa('.vuln-card').forEach(c=>{
    c.classList.toggle('hidden',sev!=='ALL'&&c.dataset.sev!==sev);
  });
}
function toggleVuln(id){
  const el=$(id);
  if(!el)return;
  el.classList.toggle('hidden');
}

// ‚îÄ‚îÄ Table filter ‚îÄ‚îÄ
function filterTable(tableId,val,colIdx){
  const tbl=$(tableId);if(!tbl)return;
  const q=val.toLowerCase();
  qsa('tbody tr',tbl).forEach(tr=>{
    const cell=tr.cells[colIdx];
    tr.style.display=(cell&&cell.textContent.toLowerCase().includes(q))||q===''?'':'none';
  });
}

// ‚îÄ‚îÄ Copy helpers ‚îÄ‚îÄ
function copyAllSubdomains(){
  const rows=qsa('#sub-table tbody tr');
  const text=[...rows].map(r=>r.cells[0]?.textContent?.trim()).filter(Boolean).join('\n');
  navigator.clipboard?.writeText(text).then(()=>flash('Copied '+rows.length+' subdomains!'));
}
function copyAllEmails(){
  const rows=qsa('#email-table tbody tr');
  const text=[...rows].map(r=>r.cells[0]?.textContent?.trim()).filter(Boolean).join('\n');
  navigator.clipboard?.writeText(text).then(()=>flash('Copied '+rows.length+' emails!'));
}
function flash(msg){
  const el=document.createElement('div');
  el.style.cssText='position:fixed;bottom:20px;right:20px;z-index:9999;padding:10px 16px;background:#10b981;color:#fff;border-radius:8px;font-size:13px;font-weight:600;box-shadow:0 4px 16px rgba(0,0,0,.3)';
  el.textContent=msg;document.body.appendChild(el);
  setTimeout(()=>el.remove(),2000);
}

// ‚îÄ‚îÄ Dropdowns ‚îÄ‚îÄ
function toggleDropdown(id){const dd=$(id);dd&&dd.classList.toggle('open')}
function initDropdowns(){
  document.addEventListener('click',e=>{
    if(!e.target.closest('.dropdown'))qsa('.dropdown-menu').forEach(m=>m.classList.remove('open'));
  });
}

// ‚îÄ‚îÄ Animate score bars on load ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  const observer=new IntersectionObserver(entries=>{
    entries.forEach(en=>{
      if(en.isIntersecting){
        qsa('.score-bar-fill',en.target).forEach(bar=>{
          bar.style.width=bar.style.width||'0%';
        });
      }
    });
  });
  qsa('.score-grid').forEach(g=>observer.observe(g));
});
</script>
{% endif %}
{% if page != "results_fragment" %}
</body></html>
{% endif %}
